<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Ollvm 虚假控制流混淆源码阅读 - 0wl’s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="0wl’s Blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="0wl’s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="如题"><meta property="og:type" content="blog"><meta property="og:title" content="Ollvm 虚假控制流混淆源码阅读"><meta property="og:url" content="https://www.0wl.site/2022/11/20/Ollvm%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81%E6%B7%B7%E6%B7%86%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/"><meta property="og:site_name" content="0wl’s Blog"><meta property="og:description" content="如题"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.0wl.site/2022/11/20/Ollvm%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81%E6%B7%B7%E6%B7%86%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/image-20221120215953333.png"><meta property="og:image" content="https://www.0wl.site/2022/11/20/Ollvm%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81%E6%B7%B7%E6%B7%86%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/upload_f23753c3beebd854c2f8bdb3bacabe5e.png"><meta property="og:image" content="https://www.0wl.site/2022/11/20/Ollvm%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81%E6%B7%B7%E6%B7%86%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/upload_e054fed402eaebaa75d8a56e9a57f914.png"><meta property="og:image" content="https://www.0wl.site/2022/11/20/Ollvm%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81%E6%B7%B7%E6%B7%86%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/upload_9619d9a713fdaba55c62387516c3da42.png"><meta property="article:published_time" content="2022-11-20T13:49:17.000Z"><meta property="article:modified_time" content="2022-11-20T14:13:30.889Z"><meta property="article:author" content="0wl"><meta property="article:tag" content="re"><meta property="article:tag" content="obf"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://www.0wl.site/2022/11/20/Ollvm%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81%E6%B7%B7%E6%B7%86%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/image-20221120215953333.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.0wl.site/2022/11/20/Ollvm%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81%E6%B7%B7%E6%B7%86%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/"},"headline":"Ollvm 虚假控制流混淆源码阅读","image":["https://www.0wl.site/2022/11/20/Ollvm%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81%E6%B7%B7%E6%B7%86%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/image-20221120215953333.png","https://www.0wl.site/2022/11/20/Ollvm%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81%E6%B7%B7%E6%B7%86%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/upload_f23753c3beebd854c2f8bdb3bacabe5e.png","https://www.0wl.site/2022/11/20/Ollvm%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81%E6%B7%B7%E6%B7%86%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/upload_e054fed402eaebaa75d8a56e9a57f914.png","https://www.0wl.site/2022/11/20/Ollvm%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81%E6%B7%B7%E6%B7%86%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/upload_9619d9a713fdaba55c62387516c3da42.png"],"datePublished":"2022-11-20T13:49:17.000Z","dateModified":"2022-11-20T14:13:30.889Z","author":{"@type":"Person","name":"0wl"},"publisher":{"@type":"Organization","name":"0wl’s Blog","logo":{"@type":"ImageObject","url":"https://www.0wl.site/img/favicon.svg"}},"description":"如题"}</script><link rel="canonical" href="https://www.0wl.site/2022/11/20/Ollvm%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81%E6%B7%B7%E6%B7%86%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?50fcb826e7ea18041d7e21129d7347e5";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="0wl’s Blog" type="application/atom+xml">
</head><body class="is-3-column"><script type="text/javascript" src="/js/imaegoo/night.js"></script><canvas id="universe"></canvas><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img class="logo-img" src="/" alt="0wl’s Blog" height="28"><img class="logo-img-dark" src="/" alt="0wl’s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives/">时间轴</a><a class="navbar-item" href="/categories/">分类</a><a class="navbar-item" href="/tags/">标签</a><a class="navbar-item" href="/about/">关于</a><a class="navbar-item" href="/friends/">友链</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i><span>  目录</span></a><a class="navbar-item night" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/0wl-alt"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-11-20T13:49:17.000Z" title="2022/11/20 下午9:49:17">2022-11-20</time>发表</span><span class="level-item"><time dateTime="2022-11-20T14:13:30.889Z" title="2022/11/20 下午10:13:30">2022-11-20</time>更新</span><span class="level-item">18 分钟读完 (大约2766个字)</span><span class="level-item leancloud_visitors" id="/2022/11/20/Ollvm%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81%E6%B7%B7%E6%B7%86%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" data-flag-title="Ollvm 虚假控制流混淆源码阅读"><i class="far fa-eye"></i>&nbsp;&nbsp;<span id="twikoo_visitors"><i class="fa fa-spinner fa-spin"></i></span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Ollvm 虚假控制流混淆源码阅读</h1><div class="content"><article class="message is-info"><div class="message-body">
<p>如题</p>
</div></article>

<span id="more"></span>

<h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><ul>
<li>llvm 介绍：<a target="_blank" rel="noopener" href="http://www.aosabook.org/en/llvm.html">http://www.aosabook.org/en/llvm.html</a></li>
<li>pass 编写：<a target="_blank" rel="noopener" href="https://llvm.org/docs/WritingAnLLVMPass.html">https://llvm.org/docs/WritingAnLLVMPass.html</a></li>
<li>ir 语法介绍：<a target="_blank" rel="noopener" href="https://llvm.org/devmtg/2019-04/slides/Tutorial-Bridgers-LLVM_IR_tutorial.pdf">https://llvm.org/devmtg/2019-04/slides/Tutorial-Bridgers-LLVM_IR_tutorial.pdf</a></li>
<li>开发手册：<a target="_blank" rel="noopener" href="https://llvm.org/docs/ProgrammersManual.html">https://llvm.org/docs/ProgrammersManual.html</a> （可以用到再查）</li>
</ul>
<h2 id="BCF"><a href="#BCF" class="headerlink" title="BCF"></a>BCF</h2><p>源码路径：<code>llvm/lib/Transforms/Obfuscation/BogusControlFlow.cpp</code></p>
<p>虚假控制流，在原来的基本块前添加新的基本块 <code>condition</code>，新的基本块<code>condition</code> 包含不透明谓词（一个表达式，表达式的值在执行到某处时已知，值运行时确定因此可以对抗静态分析），运行时会固定地跳到原来的基本块，并且复制原来的基本块并随机添加垃圾指令为一个新的基本块 <code>Altered</code>。这一过程可以多次进行（<code>-mllvm -bcf_loop=3</code> 指定循环次数），<code>-mllvm -bcf_prob=40</code> 可以按指定概率进行混淆</p>
<img src="/2022/11/20/Ollvm%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81%E6%B7%B7%E6%B7%86%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/image-20221120215953333.png" class="" title="image-20221120215953333">

<h3 id="pass-定义"><a href="#pass-定义" class="headerlink" title="pass 定义"></a>pass 定义</h3><p>单独摘出来</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">BogusControlFlow</span> : <span class="keyword">public</span> FunctionPass &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">char</span> ID; <span class="comment">// Pass identification</span></span><br><span class="line">    <span class="type">bool</span> flag;</span><br><span class="line">    <span class="built_in">BogusControlFlow</span>() : <span class="built_in">FunctionPass</span>(ID) &#123;&#125;</span><br><span class="line">    <span class="built_in">BogusControlFlow</span>(<span class="type">bool</span> flag) : <span class="built_in">FunctionPass</span>(ID) &#123;<span class="keyword">this</span>-&gt;flag = flag; <span class="built_in">BogusControlFlow</span>();&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* runOnFunction</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Overwrite FunctionPass method to apply the transformation</span></span><br><span class="line"><span class="comment">     * to the function. See header for more details.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">runOnFunction</span><span class="params">(Function &amp;F)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">bogus</span><span class="params">(Function &amp;F)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">addBogusFlow</span><span class="params">(BasicBlock * basicBlock, Function &amp;F)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> BasicBlock* <span class="title">createAlteredBasicBlock</span><span class="params">(BasicBlock * basicBlock,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> Twine &amp;  Name = <span class="string">&quot;gen&quot;</span>, Function * F = <span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">doF</span><span class="params">(Module &amp;M)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">char</span> BogusControlFlow::ID = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="type">static</span> RegisterPass&lt;BogusControlFlow&gt; <span class="title">X</span><span class="params">(<span class="string">&quot;boguscf&quot;</span>, <span class="string">&quot;inserting bogus control flow&quot;</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="bogus"><a href="#bogus" class="headerlink" title="bogus"></a>bogus</h3><p>忽略开头输出调试信息的代码，主要逻辑在下面 do-while 循环（混淆次数）。和控制流平坦化一样先保存所有的 BB</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Put all the function&#x27;s block in a list</span></span><br><span class="line">std::list&lt;BasicBlock *&gt; basicBlocks;</span><br><span class="line"><span class="keyword">for</span> (Function::iterator i=F.<span class="built_in">begin</span>();i!=F.<span class="built_in">end</span>();++i) &#123;</span><br><span class="line">    basicBlocks.<span class="built_in">push_back</span>(&amp;*i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据指定概率选择 BB 混淆，直到所有 BB 经过一次循环处理</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(!basicBlocks.<span class="built_in">empty</span>())&#123;</span><br><span class="line">    NumBasicBlocks ++;</span><br><span class="line">    <span class="comment">// Basic Blocks&#x27; selection</span></span><br><span class="line">    <span class="comment">// 通过产生随机数实现按概率选择 BB</span></span><br><span class="line">    <span class="keyword">if</span>((<span class="type">int</span>)llvm::cryptoutils-&gt;<span class="built_in">get_range</span>(<span class="number">100</span>) &lt;= ObfProbRate)&#123;</span><br><span class="line">        <span class="built_in">DEBUG_WITH_TYPE</span>(<span class="string">&quot;opt&quot;</span>, <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;bcf: Block &quot;</span></span><br><span class="line">                  &lt;&lt; NumBasicBlocks &lt;&lt;<span class="string">&quot; selected. \n&quot;</span>);</span><br><span class="line">        hasBeenModified = <span class="literal">true</span>;</span><br><span class="line">        ++NumModifiedBasicBlocks;</span><br><span class="line">        <span class="comment">// 每增加一个虚假控制流就会增加3个 BB</span></span><br><span class="line">        NumAddedBasicBlocks += <span class="number">3</span>;</span><br><span class="line">        FinalNumBasicBlocks += <span class="number">3</span>;</span><br><span class="line">        <span class="comment">// Add bogus flow to the given Basic Block (see description)</span></span><br><span class="line">        BasicBlock *basicBlock = basicBlocks.<span class="built_in">front</span>();</span><br><span class="line">        <span class="comment">// 添加虚假控制流</span></span><br><span class="line">        <span class="built_in">addBogusFlow</span>(basicBlock, F);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">DEBUG_WITH_TYPE</span>(<span class="string">&quot;opt&quot;</span>, <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;bcf: Block &quot;</span></span><br><span class="line">                  &lt;&lt; NumBasicBlocks &lt;&lt;<span class="string">&quot; not selected.\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// remove the block from the list</span></span><br><span class="line">    basicBlocks.<span class="built_in">pop_front</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(firstTime)&#123; <span class="comment">// first time we iterate on this function</span></span><br><span class="line">        ++InitNumBasicBlocks;</span><br><span class="line">        ++FinalNumBasicBlocks;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="comment">// end of while(!basicBlocks.empty())</span></span><br></pre></td></tr></table></figure>

<h3 id="addBogusFlow"><a href="#addBogusFlow" class="headerlink" title="addBogusFlow"></a>addBogusFlow</h3><p>把传入的 BB 分成两部分，第一部分只有 phi 指令、调试信息，第二部分是剩下的所有指令。这里对 BB 进行分割是为了防止 phi 指令可能产生的干扰</p>
<p>llvm ir 是 SSA（static single assignment）语言</p>
<ul>
<li>所有变量只能被赋值一次</li>
<li>所有变量在使用前必须定义</li>
</ul>
<p>phi 指令是 绕过 SSA 机制的一种方式，格式如下<br><code>&lt;result&gt; = phi &lt;ty&gt; [&lt;val0&gt;, &lt;label0&gt;], [&lt;val1&gt;, &lt;label1&gt;]</code><br><strong>会从之前执行过的 basic block 中选择值</strong></p>
<img src="/2022/11/20/Ollvm%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81%E6%B7%B7%E6%B7%86%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/upload_f23753c3beebd854c2f8bdb3bacabe5e.png" class="">

<p>如果直接添加虚假控制流可能会打乱 phi 指令执行，所以就先拆分出来</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Split the block: first part with only the phi nodes and debug info and terminator</span></span><br><span class="line">      <span class="comment">//                  created by splitBasicBlock. (-&gt; No instruction)</span></span><br><span class="line">      <span class="comment">//                  Second part with every instructions from the original block</span></span><br><span class="line">      <span class="comment">// We do this way, so we don&#x27;t have to adjust all the phi nodes, metadatas and so on</span></span><br><span class="line">      <span class="comment">// for the first block. We have to let the phi nodes in the first part, because they</span></span><br><span class="line">      <span class="comment">// actually are updated in the second part according to them.</span></span><br><span class="line">      BasicBlock::iterator i1 = basicBlock-&gt;<span class="built_in">begin</span>();</span><br><span class="line">      <span class="keyword">if</span>(basicBlock-&gt;<span class="built_in">getFirstNonPHIOrDbgOrLifetime</span>())</span><br><span class="line">          <span class="comment">// 找到分割点</span></span><br><span class="line">          i1 = (BasicBlock::iterator)basicBlock-&gt;<span class="built_in">getFirstNonPHIOrDbgOrLifetime</span>();</span><br><span class="line">      Twine *var;</span><br><span class="line">      var = <span class="keyword">new</span> <span class="built_in">Twine</span>(<span class="string">&quot;originalBB&quot;</span>);</span><br><span class="line">      <span class="comment">// 拆分</span></span><br><span class="line">      BasicBlock *originalBB = basicBlock-&gt;<span class="built_in">splitBasicBlock</span>(i1, *var);</span><br><span class="line">      <span class="built_in">DEBUG_WITH_TYPE</span>(<span class="string">&quot;gen&quot;</span>, <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;bcf: First and original basic blocks: ok\n&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>经过拆分后复制 <code>orignalBB</code> 随机添加垃圾指令得到 <code>Altered BB</code>，<code>createAlteredBasicBlock</code> 函数下面细说</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Creating the altered basic block on which the first basicBlock will jump</span></span><br><span class="line">Twine * var3 = <span class="keyword">new</span> <span class="built_in">Twine</span>(<span class="string">&quot;alteredBB&quot;</span>);</span><br><span class="line">BasicBlock *alteredBB = <span class="built_in">createAlteredBasicBlock</span>(originalBB, *var3, &amp;F);</span><br><span class="line"><span class="built_in">DEBUG_WITH_TYPE</span>(<span class="string">&quot;gen&quot;</span>, <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;bcf: Altered basic block: ok\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Now that all the blocks are created,</span></span><br><span class="line"><span class="comment">// we modify the terminators to adjust the control flow.</span></span><br><span class="line"><span class="comment">// 去掉 Terminator 为之后重建控制流</span></span><br><span class="line">alteredBB-&gt;<span class="built_in">getTerminator</span>()-&gt;<span class="built_in">eraseFromParent</span>();</span><br><span class="line">basicBlock-&gt;<span class="built_in">getTerminator</span>()-&gt;<span class="built_in">eraseFromParent</span>();</span><br><span class="line"><span class="built_in">DEBUG_WITH_TYPE</span>(<span class="string">&quot;gen&quot;</span>, <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;bcf: Terminator removed from the altered&quot;</span></span><br><span class="line">    &lt;&lt;<span class="string">&quot; and first basic blocks\n&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>创建 condition 块，重建控制流</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Preparing a condition..</span></span><br><span class="line">      <span class="comment">// For now, the condition is an always true comparaison between 2 float</span></span><br><span class="line">      <span class="comment">// This will be complicated after the pass (in doFinalization())</span></span><br><span class="line">      <span class="comment">// 结果永远为真，在 doFinalization 内复杂化条件表达式</span></span><br><span class="line">      Value * LHS = ConstantFP::<span class="built_in">get</span>(Type::<span class="built_in">getFloatTy</span>(F.<span class="built_in">getContext</span>()), <span class="number">1.0</span>);</span><br><span class="line">      Value * RHS = ConstantFP::<span class="built_in">get</span>(Type::<span class="built_in">getFloatTy</span>(F.<span class="built_in">getContext</span>()), <span class="number">1.0</span>);</span><br><span class="line">      <span class="built_in">DEBUG_WITH_TYPE</span>(<span class="string">&quot;gen&quot;</span>, <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;bcf: Value LHS and RHS created\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">// The always true condition. End of the first block</span></span><br><span class="line">      Twine * var4 = <span class="keyword">new</span> <span class="built_in">Twine</span>(<span class="string">&quot;condition&quot;</span>);</span><br><span class="line">      FCmpInst * condition = <span class="keyword">new</span> <span class="built_in">FCmpInst</span>(*basicBlock, FCmpInst::FCMP_TRUE , LHS, RHS, *var4);</span><br><span class="line">      <span class="built_in">DEBUG_WITH_TYPE</span>(<span class="string">&quot;gen&quot;</span>, <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;bcf: Always true condition created\n&quot;</span>);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// Jump to the original basic block if the condition is true or</span></span><br><span class="line">      <span class="comment">// to the altered block if false.</span></span><br><span class="line">      BranchInst::<span class="built_in">Create</span>(originalBB, alteredBB, (Value *)condition, basicBlock);</span><br><span class="line">      <span class="built_in">DEBUG_WITH_TYPE</span>(<span class="string">&quot;gen&quot;</span>,</span><br><span class="line">          <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;bcf: Terminator instruction in first basic block: ok\n&quot;</span>);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// The altered block loop back on the original one.</span></span><br><span class="line">      BranchInst::<span class="built_in">Create</span>(originalBB, alteredBB);</span><br><span class="line">      <span class="built_in">DEBUG_WITH_TYPE</span>(<span class="string">&quot;gen&quot;</span>, <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;bcf: Terminator instruction in altered block: ok\n&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>拆分出 originalBB 的 Terminator 作为新的 BB，在拆分后的 originalBB 最后添加条件跳转语句，条件始终为真跳转到原来的 Terminator（这部分对照文章最开始的那个 cfg 更好理解）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The end of the originalBB is modified to give the impression that sometimes</span></span><br><span class="line">      <span class="comment">// it continues in the loop, and sometimes it return the desired value</span></span><br><span class="line">      <span class="comment">// (of course it&#x27;s always true, so it always use the original terminator..</span></span><br><span class="line">      <span class="comment">//  but this will be obfuscated too;) )</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// iterate on instruction just before the terminator of the originalBB</span></span><br><span class="line">      BasicBlock::iterator i = originalBB-&gt;<span class="built_in">end</span>();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Split at this point (we only want the terminator in the second part)</span></span><br><span class="line">      Twine * var5 = <span class="keyword">new</span> <span class="built_in">Twine</span>(<span class="string">&quot;originalBBpart2&quot;</span>);</span><br><span class="line">      BasicBlock * originalBBpart2 = originalBB-&gt;<span class="built_in">splitBasicBlock</span>(--i , *var5);</span><br><span class="line">      <span class="built_in">DEBUG_WITH_TYPE</span>(<span class="string">&quot;gen&quot;</span>, <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;bcf: Terminator part of the original basic block&quot;</span></span><br><span class="line">          &lt;&lt; <span class="string">&quot; is isolated\n&quot;</span>);</span><br><span class="line">      <span class="comment">// the first part go either on the return statement or on the begining</span></span><br><span class="line">      <span class="comment">// of the altered block.. So we erase the terminator created when splitting.</span></span><br><span class="line">      originalBB-&gt;<span class="built_in">getTerminator</span>()-&gt;<span class="built_in">eraseFromParent</span>();</span><br><span class="line">      <span class="comment">// We add at the end a new always true condition</span></span><br><span class="line">      Twine * var6 = <span class="keyword">new</span> <span class="built_in">Twine</span>(<span class="string">&quot;condition2&quot;</span>);</span><br><span class="line">      <span class="comment">// 条件始终为 True</span></span><br><span class="line">      FCmpInst * condition2 = <span class="keyword">new</span> <span class="built_in">FCmpInst</span>(*originalBB, CmpInst::FCMP_TRUE , LHS, RHS, *var6);</span><br><span class="line">      BranchInst::<span class="built_in">Create</span>(originalBBpart2, alteredBB, (Value *)condition2, originalBB);</span><br><span class="line">      <span class="built_in">DEBUG_WITH_TYPE</span>(<span class="string">&quot;gen&quot;</span>, <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;bcf: Terminator original basic block: ok\n&quot;</span>);</span><br><span class="line">      <span class="built_in">DEBUG_WITH_TYPE</span>(<span class="string">&quot;gen&quot;</span>, <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;bcf: End of addBogusFlow().\n&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="createAlteredBasicBlock"><a href="#createAlteredBasicBlock" class="headerlink" title="createAlteredBasicBlock"></a>createAlteredBasicBlock</h3><p>调用 <code>CloneBasicBlock</code> 复制一个 BB</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Return a copy of the specified basic block, but without</span></span><br><span class="line"><span class="comment">/// embedding the block into a particular function.  The block returned is an</span></span><br><span class="line"><span class="comment">/// exact copy of the specified basic block, without any remapping having been</span></span><br><span class="line"><span class="comment">/// performed.  Because of this, this is only suitable for applications where</span></span><br><span class="line"><span class="comment">/// the basic block will be inserted into the same function that it was cloned</span></span><br><span class="line"><span class="comment">/// from (loop unrolling would use this, for example).</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Also, note that this function makes a direct copy of the basic block, and</span></span><br><span class="line"><span class="comment">/// can thus produce illegal LLVM code.  In particular, it will copy any PHI</span></span><br><span class="line"><span class="comment">/// nodes from the original block, even though there are no predecessors for the</span></span><br><span class="line"><span class="comment">/// newly cloned block (thus, phi nodes will have to be updated).  Also, this</span></span><br><span class="line"><span class="comment">/// block will branch to the old successors of the original block: these</span></span><br><span class="line"><span class="comment">/// successors will have to have any PHI nodes updated to account for the new</span></span><br><span class="line"><span class="comment">/// incoming edges.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// The correlation between instructions in the source and result basic blocks</span></span><br><span class="line"><span class="comment">/// is recorded in the VMap map.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// If you have a particular suffix you&#x27;d like to use to add to any cloned</span></span><br><span class="line"><span class="comment">/// names, specify it as the optional third parameter.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// If you would like the basic block to be auto-inserted into the end of a</span></span><br><span class="line"><span class="comment">/// function, you can specify it as the optional fourth parameter.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// If you would like to collect additional information about the cloned</span></span><br><span class="line"><span class="comment">/// function, you can specify a ClonedCodeInfo object with the optional fifth</span></span><br><span class="line"><span class="comment">/// parameter.</span></span><br><span class="line"><span class="function">BasicBlock *<span class="title">CloneBasicBlock</span><span class="params">(<span class="type">const</span> BasicBlock *BB, ValueToValueMapTy &amp;VMap,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="type">const</span> Twine &amp;NameSuffix = <span class="string">&quot;&quot;</span>, Function *F = <span class="literal">nullptr</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                            ClonedCodeInfo *CodeInfo = <span class="literal">nullptr</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                            DebugInfoFinder *DIFinder = <span class="literal">nullptr</span>)</span></span>;</span><br></pre></td></tr></table></figure>


<p>这一大段注释的大概意思是 <code>CloneBasicBlock</code> 会返回传入的 BB 的副本但不会把返回的副本插入到当前处理的函数内，这时返回的副本 BB 还存在问题需要修正（remapping）</p>
<p>副本是传入 BB 的直接拷贝，不会直接插入到函数内，如果传入的 BB 存在 phi 指令那么拷贝的副本因为没有前一个 BB 就会产生错误。同时，拷贝的副本会有到原来传入 BB 后继块的分支，原来 BB 后继块内的 phi 结构就需要调整</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">ValueToValueMapTy VMap;</span><br><span class="line">      BasicBlock * alteredBB = llvm::<span class="built_in">CloneBasicBlock</span> (basicBlock, VMap, Name, F);</span><br><span class="line">      <span class="built_in">DEBUG_WITH_TYPE</span>(<span class="string">&quot;gen&quot;</span>, <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;bcf: Original basic block cloned\n&quot;</span>);</span><br><span class="line">      <span class="comment">// Remap operands.</span></span><br><span class="line">      BasicBlock::iterator ji = basicBlock-&gt;<span class="built_in">begin</span>();</span><br><span class="line">      <span class="keyword">for</span> (BasicBlock::iterator i = alteredBB-&gt;<span class="built_in">begin</span>(), e = alteredBB-&gt;<span class="built_in">end</span>() ; i != e; ++i)&#123;</span><br><span class="line">        <span class="comment">// Loop over the operands of the instruction</span></span><br><span class="line">        <span class="comment">// 重新调整操作数</span></span><br><span class="line">        <span class="keyword">for</span>(User::op_iterator opi = i-&gt;<span class="built_in">op_begin</span> (), ope = i-&gt;<span class="built_in">op_end</span>(); opi != ope; ++opi)&#123;</span><br><span class="line">          <span class="comment">// get the value for the operand</span></span><br><span class="line">          Value *v = <span class="built_in">MapValue</span>(*opi, VMap,  RF_None, <span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> (v != <span class="number">0</span>)&#123;</span><br><span class="line">            *opi = v;</span><br><span class="line">            <span class="built_in">DEBUG_WITH_TYPE</span>(<span class="string">&quot;gen&quot;</span>, <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;bcf: Value&#x27;s operand has been setted\n&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">DEBUG_WITH_TYPE</span>(<span class="string">&quot;gen&quot;</span>, <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;bcf: Operands remapped\n&quot;</span>);</span><br><span class="line">        <span class="comment">// Remap phi nodes&#x27; incoming blocks.</span></span><br><span class="line">        <span class="comment">// 这里对 phi 的处理有些看不懂，好像没有改原来 BB 后继块的 phi 指令？</span></span><br><span class="line">        <span class="keyword">if</span> (PHINode *pn = <span class="built_in">dyn_cast</span>&lt;PHINode&gt;(i)) &#123;</span><br><span class="line">          <span class="keyword">for</span> (<span class="type">unsigned</span> j = <span class="number">0</span>, e = pn-&gt;<span class="built_in">getNumIncomingValues</span>(); j != e; ++j) &#123;</span><br><span class="line">            Value *v = <span class="built_in">MapValue</span>(pn-&gt;<span class="built_in">getIncomingBlock</span>(j), VMap, RF_None, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (v != <span class="number">0</span>)&#123;</span><br><span class="line">              pn-&gt;<span class="built_in">setIncomingBlock</span>(j, <span class="built_in">cast</span>&lt;BasicBlock&gt;(v));</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 下面 remap metadata 和调试信息</span></span><br><span class="line">        <span class="built_in">DEBUG_WITH_TYPE</span>(<span class="string">&quot;gen&quot;</span>, <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;bcf: PHINodes remapped\n&quot;</span>);</span><br><span class="line">        <span class="comment">// Remap attached metadata.</span></span><br><span class="line">        SmallVector&lt;std::pair&lt;<span class="type">unsigned</span>, MDNode *&gt;, <span class="number">4</span>&gt; MDs;</span><br><span class="line">        i-&gt;<span class="built_in">getAllMetadata</span>(MDs);</span><br><span class="line">        <span class="built_in">DEBUG_WITH_TYPE</span>(<span class="string">&quot;gen&quot;</span>, <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;bcf: Metadatas remapped\n&quot;</span>);</span><br><span class="line">        <span class="comment">// important for compiling with DWARF, using option -g.</span></span><br><span class="line">        i-&gt;<span class="built_in">setDebugLoc</span>(ji-&gt;<span class="built_in">getDebugLoc</span>());</span><br><span class="line">        ji++;</span><br><span class="line">        <span class="built_in">DEBUG_WITH_TYPE</span>(<span class="string">&quot;gen&quot;</span>, <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;bcf: Debug information location setted\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">      &#125; <span class="comment">// The instructions&#x27; informations are now all correct</span></span><br><span class="line">      <span class="comment">// 到此结束副本的修正</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>PHINode 类注释<br>PHINode - The PHINode class is used to represent the magical mystical PHI<br>node, <strong>that can not exist in nature</strong>, but can be synthesized in a computer<br>scientist’s overactive imagination.</p>
</blockquote>
<p>看起来 phi 没有在实际当中使用</p>
<p>接下来插入随机的垃圾指令，分为整数和浮点数两种情况进行处理，遇到运算指令和比较指令就进行随机的插入或替换。</p>
<h3 id="doF"><a href="#doF" class="headerlink" title="doF"></a>doF</h3><p>这个函数会对之前添加的虚假块（condution）最后的跳转条件复杂化，创建两个全局变量 x 和 y，两层 for 循环记录下所有虚假块的跳转条件、分支跳转语句分别到 <code>toDelete</code> 和 <code>toEdit</code> 两个数组</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(Module::iterator mi = M.<span class="built_in">begin</span>(), me = M.<span class="built_in">end</span>(); mi != me; ++mi)&#123;</span><br><span class="line">        <span class="keyword">for</span>(Function::iterator fi = mi-&gt;<span class="built_in">begin</span>(), fe = mi-&gt;<span class="built_in">end</span>(); fi != fe; ++fi)&#123;</span><br><span class="line">          <span class="comment">//fi-&gt;setName(&quot;&quot;);</span></span><br><span class="line">          TerminatorInst * tbb= fi-&gt;<span class="built_in">getTerminator</span>();</span><br><span class="line">          <span class="keyword">if</span>(tbb-&gt;<span class="built_in">getOpcode</span>() == Instruction::Br)&#123;</span><br><span class="line">            BranchInst * br = (BranchInst *)(tbb);</span><br><span class="line">            <span class="comment">// 判断是否是条件跳转</span></span><br><span class="line">            <span class="keyword">if</span>(br-&gt;<span class="built_in">isConditional</span>())&#123;</span><br><span class="line">              FCmpInst * cond = (FCmpInst *)br-&gt;<span class="built_in">getCondition</span>();</span><br><span class="line">              <span class="type">unsigned</span> opcode = cond-&gt;<span class="built_in">getOpcode</span>();</span><br><span class="line">              <span class="keyword">if</span>(opcode == Instruction::FCmp)&#123;</span><br><span class="line">              <span class="comment">// 条件固定为真就说明是前面过程添加的 condition 块</span></span><br><span class="line">                <span class="keyword">if</span> (cond-&gt;<span class="built_in">getPredicate</span>() == FCmpInst::FCMP_TRUE)&#123;</span><br><span class="line">                  <span class="built_in">DEBUG_WITH_TYPE</span>(<span class="string">&quot;gen&quot;</span>,</span><br><span class="line">                      <span class="built_in">errs</span>()&lt;&lt;<span class="string">&quot;bcf: an always true predicate !\n&quot;</span>);</span><br><span class="line">                  toDelete.<span class="built_in">push_back</span>(cond); <span class="comment">// The condition</span></span><br><span class="line">                  toEdit.<span class="built_in">push_back</span>(tbb);    <span class="comment">// The branch using the condition</span></span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">/*</span></span><br><span class="line"><span class="comment">          for (BasicBlock::iterator bi = fi-&gt;begin(), be = fi-&gt;end() ; bi != be; ++bi)&#123;</span></span><br><span class="line"><span class="comment">            bi-&gt;setName(&quot;&quot;); // setting the basic blocks&#x27; names</span></span><br><span class="line"><span class="comment">          &#125;</span></span><br><span class="line"><span class="comment">          */</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>替换所有之前记录的分支跳转</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Replacing all the branches we found</span></span><br><span class="line">      <span class="keyword">for</span>(std::vector&lt;Instruction*&gt;::iterator i =toEdit.<span class="built_in">begin</span>();i!=toEdit.<span class="built_in">end</span>();++i)&#123;</span><br><span class="line">        <span class="comment">//if y &lt; 10 || x*(x+1) % 2 == 0</span></span><br><span class="line">        opX = <span class="keyword">new</span> <span class="built_in">LoadInst</span> ((Value *)x, <span class="string">&quot;&quot;</span>, (*i));</span><br><span class="line">        opY = <span class="keyword">new</span> <span class="built_in">LoadInst</span> ((Value *)y, <span class="string">&quot;&quot;</span>, (*i));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// x-1  和上面注释写的不太一样</span></span><br><span class="line">        op = BinaryOperator::<span class="built_in">Create</span>(Instruction::Sub, (Value *)opX,</span><br><span class="line">            ConstantInt::<span class="built_in">get</span>(Type::<span class="built_in">getInt32Ty</span>(M.<span class="built_in">getContext</span>()), <span class="number">1</span>,</span><br><span class="line">              <span class="literal">false</span>), <span class="string">&quot;&quot;</span>, (*i));</span><br><span class="line">        <span class="comment">// x*(x-1)</span></span><br><span class="line">        op1 = BinaryOperator::<span class="built_in">Create</span>(Instruction::Mul, (Value *)opX, op, <span class="string">&quot;&quot;</span>, (*i));</span><br><span class="line">        <span class="comment">// x*(x-1)%2</span></span><br><span class="line">        op = BinaryOperator::<span class="built_in">Create</span>(Instruction::URem, op1,</span><br><span class="line">            ConstantInt::<span class="built_in">get</span>(Type::<span class="built_in">getInt32Ty</span>(M.<span class="built_in">getContext</span>()), <span class="number">2</span>,</span><br><span class="line">              <span class="literal">false</span>), <span class="string">&quot;&quot;</span>, (*i));</span><br><span class="line">        <span class="comment">// x*(x-1)%2 == 0</span></span><br><span class="line">        condition = <span class="keyword">new</span> <span class="built_in">ICmpInst</span>((*i), ICmpInst::ICMP_EQ, op,</span><br><span class="line">            ConstantInt::<span class="built_in">get</span>(Type::<span class="built_in">getInt32Ty</span>(M.<span class="built_in">getContext</span>()), <span class="number">0</span>,</span><br><span class="line">              <span class="literal">false</span>));</span><br><span class="line">        <span class="comment">// y &lt; 10</span></span><br><span class="line">        condition2 = <span class="keyword">new</span> <span class="built_in">ICmpInst</span>((*i), ICmpInst::ICMP_SLT, opY,</span><br><span class="line">            ConstantInt::<span class="built_in">get</span>(Type::<span class="built_in">getInt32Ty</span>(M.<span class="built_in">getContext</span>()), <span class="number">10</span>,</span><br><span class="line">              <span class="literal">false</span>));</span><br><span class="line">        <span class="comment">// 最后产生的条件 y &lt; 10 || x*(x-1) % 2 == 0 x=y=0 条件固定为真</span></span><br><span class="line">        op1 = BinaryOperator::<span class="built_in">Create</span>(Instruction::Or, (Value *)condition,</span><br><span class="line">            (Value *)condition2, <span class="string">&quot;&quot;</span>, (*i));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 替换分支</span></span><br><span class="line">        BranchInst::<span class="built_in">Create</span>(((BranchInst*)*i)-&gt;<span class="built_in">getSuccessor</span>(<span class="number">0</span>),</span><br><span class="line">            ((BranchInst*)*i)-&gt;<span class="built_in">getSuccessor</span>(<span class="number">1</span>),(Value *) op1,</span><br><span class="line">            ((BranchInst*)*i)-&gt;<span class="built_in">getParent</span>());</span><br><span class="line">        <span class="built_in">DEBUG_WITH_TYPE</span>(<span class="string">&quot;gen&quot;</span>, <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;bcf: Erase branch instruction:&quot;</span></span><br><span class="line">            &lt;&lt; *((BranchInst*)*i) &lt;&lt; <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        (*i)-&gt;<span class="built_in">eraseFromParent</span>(); <span class="comment">// erase the branch</span></span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>到此结束整个 bcf 混淆过程</p>
<h3 id="混淆前后对比"><a href="#混淆前后对比" class="headerlink" title="混淆前后对比"></a>混淆前后对比</h3><img src="/2022/11/20/Ollvm%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81%E6%B7%B7%E6%B7%86%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/upload_e054fed402eaebaa75d8a56e9a57f914.png" class="">

<img src="/2022/11/20/Ollvm%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81%E6%B7%B7%E6%B7%86%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/upload_9619d9a713fdaba55c62387516c3da42.png" class="">

<p>ollvm 的虚假控制流混淆实际上还有许多能够优化的地方，比如在代码执行过程更改不透明谓词中全局变量的值（当前代码全局变量固定值 0），添加随机垃圾指令时加花之类的</p>
<h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/obfuscator-llvm/obfuscator/wiki/Bogus-Control-Flow">Bogus Control Flow</a></li>
<li><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-266201.htm">OLLVM虚假控制流源码学习笔记</a></li>
</ul>
</div><div class="article-licensing box"><div class="licensing-title"><p>Ollvm 虚假控制流混淆源码阅读</p><p><a href="https://www.0wl.site/2022/11/20/Ollvm虚假控制流混淆源码阅读/">https://www.0wl.site/2022/11/20/Ollvm虚假控制流混淆源码阅读/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>0wl</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2022-11-20</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2022-11-20</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/re/">re</a><a class="link-muted mr-2" rel="tag" href="/tags/obf/">obf</a></div><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" target="_blank" rel="noopener" href="https://www.addtoany.com/share"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_reddit"></a></div><script src="https://static.addtoany.com/menu/page.js" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" href="/" target="_blank" rel="noopener" data-type="afdian"><span class="icon is-small"><i class="fas fa-charging-station"></i></span><span>爱发电</span></a><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/alipay.jpg" alt="支付宝"></span></a><a class="button donate" href="/" target="_blank" rel="noopener" data-type="buymeacoffee"><span class="icon is-small"><i class="fas fa-coffee"></i></span><span>送我杯咖啡</span></a><a class="button donate" href="/" target="_blank" rel="noopener" data-type="patreon"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/wechat.png" alt="微信"></span></a></div></div></div><div class="card"><nav class="post-navigation mt-4 level is-mobile card-content"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2022/10/05/%E5%AE%89%E5%8D%93%E6%8A%93%E5%8C%85%E6%80%BB%E7%BB%93/"><span class="level-item">安卓抓包总结</span><i class="level-item fas fa-chevron-right"></i></a></div></nav></div><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div class="content twikoo" id="twikoo"></div><script src="https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js"></script><script>twikoo.init({
      envId: 'blog-9gu02qis60845ab5'
    });</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatar.jpg" alt="0wl"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">0wl</p><p class="is-size-6 is-block">HDU / CTFer / Re</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Hangzhou, China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">20</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">1</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">14</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/0wl-alt" target="_blank" rel="noopener" id="widget-follow">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/0wl-alt"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#前置知识"><span class="level-left"><span class="level-item">前置知识</span></span></a></li><li><a class="level is-mobile" href="#BCF"><span class="level-left"><span class="level-item">BCF</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#pass-定义"><span class="level-left"><span class="level-item">pass 定义</span></span></a></li><li><a class="level is-mobile" href="#bogus"><span class="level-left"><span class="level-item">bogus</span></span></a></li><li><a class="level is-mobile" href="#addBogusFlow"><span class="level-left"><span class="level-item">addBogusFlow</span></span></a></li><li><a class="level is-mobile" href="#createAlteredBasicBlock"><span class="level-left"><span class="level-item">createAlteredBasicBlock</span></span></a></li><li><a class="level is-mobile" href="#doF"><span class="level-left"><span class="level-item">doF</span></span></a></li><li><a class="level is-mobile" href="#混淆前后对比"><span class="level-left"><span class="level-item">混淆前后对比</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Ref"><span class="level-left"><span class="level-item">Ref</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/MFC/"><span class="tag">MFC</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/android/"><span class="tag">android</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/buu/"><span class="tag">buu</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cve%E5%A4%8D%E7%8E%B0/"><span class="tag">cve复现</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/gdb/"><span class="tag">gdb</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hgame/"><span class="tag">hgame</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/obf/"><span class="tag">obf</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pwn/"><span class="tag">pwn</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/qemu/"><span class="tag">qemu</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/re/"><span class="tag">re</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/riscv/"><span class="tag">riscv</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/upx/"><span class="tag">upx</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/windows/"><span class="tag">windows</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/wp/"><span class="tag">wp</span><span class="tag">6</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img class="logo-img" src="/" alt="0wl’s Blog" height="28"><img class="logo-img-dark" src="/" alt="0wl’s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2022 0wl</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/imaegoo/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script>if (typeof 0 !== 'undefined' 
            && true == true) {
            $(document).ready(function () {
                var int = setInterval(fixCount, 100);
                var busuanziSiteOffset = parseInt(0);
                function fixCount() {
                    if ($("#busuanzi_container_site_uv").css("display") != "none" && parseInt($("#busuanzi_value_site_uv").html()) > 0) {
                        clearInterval(int);
                        $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + busuanziSiteOffset);
                    }
                }
            });
        }</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用 Cookie，以启用评论系统和分析功能。",
          dismiss: "知道了",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><div class="searchbox-pinyin"><label class="checkbox"><input id="search-by-pinyin" type="checkbox" checked="checked"><span> 拼音检索</span></label></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/imaegoo/pinyin.js" defer></script><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script type="text/javascript" src="/js/imaegoo/imaegoo.js"></script><script type="text/javascript" src="/js/imaegoo/universe.js"></script><script type="text/javascript" src="/js/live2d/autoload.js"></script></body></html>